import React, { useState, useEffect, useMemo, useRef } from 'react';
import { MirrorGradientContainer, usePanelRegistration } from '../components/MirrorGradientProvider';
import { FaStar, FaRoute, FaHeart, FaCog } from 'react-icons/fa';
import FivePointStar from '../components/Map/FivePointStar';
import LazyYandexMap from '../components/YandexMap/LazyYandexMap';
import { getAllZones, checkRoute } from '../services/zoneService';
import PlannerAccordion from '../components/Planner/PlannerAccordion';
import FavoritesPanel from '../components/FavoritesPanel';
import RouteRebuildModal from '../components/Planner/RouteRebuildModal';
// import RouteOrderPanel from '../components/Planner/RouteOrderPanel'; // –£–±—Ä–∞–Ω–æ - —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
import RouteCategoryModal, { RouteCreationData } from '../components/Planner/RouteCategoryModal';
import RouteCategorySelector from '../components/Planner/RouteCategorySelector';
import CoordinateInput from '../components/Planner/CoordinateInput';

import { MarkerData } from '../types/marker';
import { RouteData } from '../types/route';
import { getRoutePolyline } from '../services/routingService';
import { createRoute, deleteRoute } from '../api/routes';
import apiClient from '../api/apiClient';
import { useAuth } from '../contexts/AuthContext';
import { useFavorites } from '../contexts/FavoritesContext';
import { useRoutePlanner } from '../contexts/RoutePlannerContext';
import { useRouteBuilder } from '../hooks/useRouteBuilder';
import { RoutePoint as UnifiedRoutePoint, PointSource } from '../types/routeBuilder';
import { useLayoutState } from '../contexts/LayoutContext';
import '../styles/GlobalStyles.css';
import '../styles/PageLayout.css';
import '../styles/FireMarkers.css';

// –°—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç—ã - –ù–ï –ü–ï–†–ï–°–û–ó–î–ê–ï–¢–°–Ø
const StableMap = React.memo(({ 
  onMapReady, 
  onMapClick, 
  markers, 
  routeLine,
  displayedRoutePolylines,
  shouldCenterOnRoute,
  zones,
  suppressAutoFit
}: {
  onMapReady: () => void;
  onMapClick: (coordinates: [number, number]) => void;
  markers: Array<{ id: string; coordinates: [number, number]; title: string; description?: string; source?: string }>;
  routeLine: [number, number][];
  displayedRoutePolylines: Array<{id: string, polyline: [number, number][], color: string}>;
  shouldCenterOnRoute: boolean;
  zones: Array<{ severity?: string; polygons: number[][][]; name?: string; type?: string }>;
  suppressAutoFit: boolean;
}) => {
  // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Ä–∫–µ—Ä–æ–≤
  const getMapCenter = () => {
    // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ –∏ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä—ã - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
    if (shouldCenterOnRoute && markers.length > 0) {
      if (markers.length === 1) {
        return markers[0].coordinates;
      } else {
        // –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –º–µ–∂–¥—É –≤—Å–µ–º–∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞
        const latitudes = markers.map(m => m.coordinates[0]);
        const longitudes = markers.map(m => m.coordinates[1]);
        
        const centerLat = (Math.min(...latitudes) + Math.max(...latitudes)) / 2;
        const centerLon = (Math.min(...longitudes) + Math.max(...longitudes)) / 2;
        
        return [centerLat, centerLon] as [number, number];
      }
    }
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ä—à—Ä—É—Ç (–ø–æ–ª–∏–ª–∏–Ω–∏—è) - —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ –Ω–µ–º
    if (routeLine && routeLine.length > 0) {
      const routeLatitudes = routeLine.map(point => point[0]);
      const routeLongitudes = routeLine.map(point => point[1]);
      
      const centerLat = (Math.min(...routeLatitudes) + Math.max(...routeLatitudes)) / 2;
      const centerLon = (Math.min(...routeLongitudes) + Math.max(...routeLongitudes)) / 2;
      
      return [centerLat, centerLon] as [number, number];
    }
    
    // –û–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
    if (markers.length === 0) {
      // –ï—Å–ª–∏ –Ω–µ—Ç –º–∞—Ä–∫–µ—Ä–æ–≤ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ —Å–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      return null;
    } else if (markers.length === 1) {
      // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Ç–æ—á–∫–∞ –∏ –Ω–µ –Ω—É–∂–Ω–æ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Ü–µ–Ω—Ç—Ä,
      // —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä—ã–∂–∫–æ–≤ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–≤–æ–π –º–µ—Ç–∫–∏
      return null;
    } else {
      // –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∞—Ä–∫–µ—Ä–æ–≤ - –≤—ã—á–∏—Å–ª—è–µ–º —Ü–µ–Ω—Ç—Ä –º–µ–∂–¥—É –≤—Å–µ–º–∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏
      const latitudes = markers.map(m => m.coordinates[0]);
      const longitudes = markers.map(m => m.coordinates[1]);
      
      const centerLat = (Math.min(...latitudes) + Math.max(...latitudes)) / 2;
      const centerLon = (Math.min(...longitudes) + Math.max(...longitudes)) / 2;
      
      return [centerLat, centerLon] as [number, number];
    }
  };

  // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∑—É–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Ä–∫–µ—Ä–æ–≤
  const getMapZoom = () => {
    // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ –∏ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä—ã - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º
    if (shouldCenterOnRoute && markers.length > 0) {
      if (markers.length === 1) {
        return 12; // –î–µ—Ç–∞–ª—å–Ω—ã–π –≤–∏–¥ –æ–¥–Ω–æ–π —Ç–æ—á–∫–∏
      } else {
        // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∑—É–º –¥–ª—è –æ—Ö–≤–∞—Ç–∞ –≤—Å–µ—Ö —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞
        const latitudes = markers.map(m => m.coordinates[0]);
        const longitudes = markers.map(m => m.coordinates[1]);
        
        const latDiff = Math.max(...latitudes) - Math.min(...latitudes);
        const lonDiff = Math.max(...longitudes) - Math.min(...longitudes);
        const maxDiff = Math.max(latDiff, lonDiff);
        
        // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∑—É–º –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
        if (maxDiff > 5) return 6;      // –ë–æ–ª—å—à–∏–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (–º–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏)
        if (maxDiff > 1) return 8;      // –°—Ä–µ–¥–Ω–∏–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
        if (maxDiff > 0.1) return 10;   // –ú–∞–ª—ã–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
        return 12;                       // –û—á–µ–Ω—å –±–ª–∏–∑–∫–∏–µ —Ç–æ—á–∫–∏
      }
    }
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ä—à—Ä—É—Ç - –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –ø–æ–¥ –Ω–µ–≥–æ
    if (routeLine && routeLine.length > 0) {
      const routeLatitudes = routeLine.map(point => point[0]);
      const routeLongitudes = routeLine.map(point => point[1]);
      
      const latDiff = Math.max(...routeLatitudes) - Math.min(...routeLatitudes);
      const lonDiff = Math.max(...routeLongitudes) - Math.min(...routeLongitudes);
      const maxDiff = Math.max(latDiff, lonDiff);
      
      // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∑—É–º –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞
      if (maxDiff > 5) return 6;      // –ë–æ–ª—å—à–∏–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (–º–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏)
      if (maxDiff > 1) return 8;      // –°—Ä–µ–¥–Ω–∏–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
      if (maxDiff > 0.1) return 10;   // –ú–∞–ª—ã–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
      return 12;                       // –û—á–µ–Ω—å –±–ª–∏–∑–∫–∏–µ —Ç–æ—á–∫–∏
    }
    
    // –û–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑—É–º–∞
    if (markers.length === 0) {
      return 10; // –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∑—É–º –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç–æ—á–µ–∫
    } else if (markers.length === 1) {
      // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Ç–æ—á–∫–∞ –∏ –Ω–µ –Ω—É–∂–Ω–æ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑—É–º,
      // —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∞ "–ø—É–ª—å—Å–∞—Ü–∏–∏" –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–≤–æ–π –º–µ—Ç–∫–∏
      return 10;
    } else {
      // –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∞—Ä–∫–µ—Ä–æ–≤ - –≤—ã—á–∏—Å–ª—è–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∑—É–º –¥–ª—è –æ—Ö–≤–∞—Ç–∞ –≤—Å–µ—Ö —Ç–æ—á–µ–∫
      const latitudes = markers.map(m => m.coordinates[0]);
      const longitudes = markers.map(m => m.coordinates[1]);
      
      const latDiff = Math.max(...latitudes) - Math.min(...latitudes);
      const lonDiff = Math.max(...longitudes) - Math.min(...longitudes);
      const maxDiff = Math.max(latDiff, lonDiff);
      
      // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∑—É–º –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
      if (maxDiff > 5) return 6;      // –ë–æ–ª—å—à–∏–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (–º–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏)
      if (maxDiff > 1) return 8;      // –°—Ä–µ–¥–Ω–∏–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
      if (maxDiff > 0.1) return 10;   // –ú–∞–ª—ã–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
      return 12;                       // –û—á–µ–Ω—å –±–ª–∏–∑–∫–∏–µ —Ç–æ—á–∫–∏
    }
  };

  return (
    <LazyYandexMap
      key="planner-map-stable-component"
      center={getMapCenter()}
      zoom={getMapZoom()}
      markers={markers}
      onMapClick={onMapClick}
      routeLine={routeLine}
      displayedRoutePolylines={displayedRoutePolylines}
      onMapReady={onMapReady}
      autoFitBounds={Boolean(!suppressAutoFit && (shouldCenterOnRoute || routeLine.length > 1 || markers.length > 1))}
      zones={zones}
    />
  );
});

// –°—Ç–∞–±–∏–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ - –ù–ï –î–ï–†–ì–ê–ï–¢–°–Ø
const StableHeader = React.memo(({ showZonesLayer, setShowZonesLayer }: { showZonesLayer: boolean; setShowZonesLayer: (show: boolean) => void }) => {
  return (
    <div className="map-content-header">
      <div className="flex items-center justify-between w-full">
        <div className="flex items-center space-x-2">
          <FaRoute className="w-5 h-5 text-slate-400" />
          <h1 className="text-lg font-semibold text-slate-800">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤</h1>
        </div>
        
        <div className="flex items-center space-x-3 justify-center flex-1">
          {/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–ª–æ—è –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö –∑–æ–Ω */}
          <button
            onClick={() => setShowZonesLayer(!showZonesLayer)}
            className={`flex items-center space-x-2 px-3 py-1 rounded-full transition-colors ${
              showZonesLayer 
                ? 'bg-red-100 text-red-700 border border-red-200' 
                : 'bg-gray-100 text-gray-600 border border-gray-200'
            }`}
            title={showZonesLayer ? '–°–∫—Ä—ã—Ç—å –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ –∑–æ–Ω—ã' : '–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ –∑–æ–Ω—ã'}
          >
            <span className="text-sm">üö´</span>
            <span className="text-sm font-medium">
              {showZonesLayer ? '–ó–æ–Ω—ã —Å–∫—Ä—ã—Ç—ã' : '–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ –∑–æ–Ω—ã'}
            </span>
          </button>
          
          {/* –°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω */}
          <div className="flex items-center space-x-2 px-3 py-1 bg-gray-100 rounded-full">
            <span className="text-lg">üéí</span>
            <span className="text-sm font-medium text-green-600">–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫</span>
          </div>
        </div>
      </div>
      
      {/* –í–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ */}
      <div className="text-sm text-gray-600 italic text-center mt-2 px-20">
        "–°–æ–∑–¥–∞–π—Ç–µ –º–∞—Ä—à—Ä—É—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞—Å—Å–∫–∞–∂–µ—Ç –∏—Å—Ç–æ—Ä–∏—é"
      </div>
    </div>
  );
});

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≤—ã–±–æ—Ä–∞ —Å–ª–æ—è –∫–∞—Ä—Ç—ã

interface PlannerProps {
  selectedRouteId?: string;
  showOnlySelected?: boolean;
}

const Planner: React.FC<PlannerProps> = () => {
  const { registerPanel, unregisterPanel } = usePanelRegistration();
  const [zones, setZones] = useState<Array<{ severity?: string; polygons: number[][][]; name?: string; type?: string }>>([]);
  const [showZonesLayer, setShowZonesLayer] = useState(false);
  
  // –ï–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
  const {
    routeState,
    pointManager,
    activePoints,
    routePolyline: unifiedRoutePolyline,
    isBuilding,
    canBuild,
    stats
  } = useRouteBuilder();

  // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤—ã–¥–≤–∏–≥–∞—é—â–∏—Ö—Å—è –ø–∞–Ω–µ–ª–µ–π (–∏–∑ FavoritesContext)
  const favoritesCtx = useFavorites();
  const favoritesOpen = (favoritesCtx as any)?.favoritesOpen ?? false;
  const setFavoritesOpen = (favoritesCtx as any)?.setFavoritesOpen ?? (() => {});
  useEffect(() => {
    registerPanel(); // –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    registerPanel(); // –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏–∑–±—Ä–∞–Ω–Ω—ã–º
    return () => {
      unregisterPanel(); // –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å
      unregisterPanel(); // –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å
    };
  }, [registerPanel, unregisterPanel]);

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ message channel
  useEffect(() => {
    const handleUnhandledRejection = (event: PromiseRejectionEvent) => {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ message channel (–æ–±—ã—á–Ω–æ –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä–∞)
      if (event.reason && event.reason.message && 
          event.reason.message.includes('message channel closed')) {
        event.preventDefault();
        return;
      }
    };

    const handleError = (event: ErrorEvent) => {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ message channel
      if (event.message && event.message.includes('message channel closed')) {
        event.preventDefault();
        return;
      }
    };

    window.addEventListener('unhandledrejection', handleUnhandledRejection);
    window.addEventListener('error', handleError);

    return () => {
      window.removeEventListener('unhandledrejection', handleUnhandledRejection);
      window.removeEventListener('error', handleError);
    };
  }, []);

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö –∑–æ–Ω –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
  useEffect(() => {
    getAllZones().then(setZones).catch(() => {});
  }, []);

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤—ã–¥–≤–∏–≥–∞—é—â–∏—Ö—Å—è –ø–∞–Ω–µ–ª–µ–π
  const [settingsOpen, setSettingsOpen] = useState(false);
  
  // –ü–∞–Ω–µ–ª–∏ –ø–æ—Ä—è–¥–∫–∞ —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
  const [isRebuildModalOpen, setIsRebuildModalOpen] = useState(false);
  // const [isOrderPanelOpen, setIsOrderPanelOpen] = useState(false); // –£–±—Ä–∞–Ω–æ - —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
  const [shouldCenterOnRoute, setShouldCenterOnRoute] = useState(false);
  const autoCenterTimerRef = useRef<number | null>(null);
  const triggerAutoCenter = (durationMs: number = 800) => {
    try {
      if (autoCenterTimerRef.current) {
        clearTimeout(autoCenterTimerRef.current);
        autoCenterTimerRef.current = null;
      }
      setShouldCenterOnRoute(true);
      autoCenterTimerRef.current = window.setTimeout(() => {
        setShouldCenterOnRoute(false);
        autoCenterTimerRef.current = null;
      }, durationMs);
    } catch {}
  };
  
  const [selectedRoute, setSelectedRoute] = useState<RouteData | null>(null);
  const [routePolyline, setRoutePolyline] = useState<[number, number][]>([]);
  const [isMapReady, setIsMapReady] = useState(false);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
  const [selectedRouteIds, setSelectedRouteIds] = useState<string[]>([]);
  const [displayedRoutePolylines, setDisplayedRoutePolylines] = useState<Array<{id: string, polyline: [number, number][], color: string}>>([]);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  const [debugInfo, setDebugInfo] = useState<string>('');
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
  const [lastBuiltRoute, setLastBuiltRoute] = useState<string>('');
  
  // –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
  const [showCategoryModal, setShowCategoryModal] = useState(false);
  const [showCoordinateInput, setShowCoordinateInput] = useState(false);
  const [showSearchForm, setShowSearchForm] = useState(false);
  const [pendingRouteData, setPendingRouteData] = useState<{
    title: string;
    points: any[];
  } | null>(null);
  
  // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è - —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–µ–µ
  const [lastRouteCreated, setLastRouteCreated] = useState<string | null>(null);

  const auth = useAuth();
  const layoutContext = useLayoutState();
  const [favoritesTab] = useState<'places' | 'routes'>('places');
  const [favoritesPanelKey, setFavoritesPanelKey] = useState(0);
  const favoritesContext = useFavorites();
  const routePlannerContext = useRoutePlanner();
  const { selectedMarkerIds = [], setSelectedMarkerIds = () => {} } = (favoritesContext as any) || {};

  // –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ö—Ä–∞–Ω–∏—Ç –æ—Ç–∫—Ä—ã—Ç—É—é –ø–∞–Ω–µ–ª—å –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã; –ª–æ–∫–∞–ª—å–Ω–∞—è –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –Ω–µ –Ω—É–∂–Ω–∞
  useEffect(() => {}, []);

  // –û—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ FavoritesContext

  // –í—ã–±–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ FavoritesContext

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã
  if (!auth || !layoutContext || !favoritesContext || !routePlannerContext) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞...</p>
        </div>
      </div>
    );
  }

  const { token } = auth;
  const { setLeftContent, setRightContent } = layoutContext;
  const { favoritePlaces, removeFavoritePlace, favoriteRoutes } = favoritesContext || {
    favoritePlaces: [],
    removeFavoritePlace: () => {},
    favoriteRoutes: []
  };

  // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö ID: —É–¥–∞–ª—è–µ–º —Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Ç–µ–∫—É—â–µ–º —Å–ø–∏—Å–∫–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
  useEffect(() => {
    if (!Array.isArray(selectedMarkerIds)) return;
    const validIds = new Set(favoritePlaces.map(p => p.id));
    const filtered = selectedMarkerIds.filter(id => validIds.has(id));
    if (filtered.length !== selectedMarkerIds.length) {
      setSelectedMarkerIds(filtered as string[]);
    }
  }, [favoritePlaces, selectedMarkerIds, setSelectedMarkerIds]);

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º FavoritePlace –≤ MarkerData –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  const favorites: MarkerData[] = favoritePlaces.map((place): MarkerData => ({
    id: place.id,
    latitude: place.coordinates[0],
    longitude: place.coordinates[1],
    title: place.name,
    description: place.type,
    address: place.location,
    category: place.type,
    rating: place.rating,
    rating_count: 0,
    photo_urls: [],
    hashtags: [],
    author_name: 'User',
    created_at: place.addedAt.toISOString(),
    updated_at: place.addedAt.toISOString(),
    likes_count: 0,
    comments_count: 0,
    shares_count: 0
  }));

  // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –º–µ—Ç–æ–∫, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä—è–º–æ –Ω–∞ –∫–∞—Ä—Ç—É
  const [mapClickMarkers, setMapClickMarkers] = useState<Array<{
    id: string;
    coordinates: [number, number];
    title: string;
    description?: string;
  }>>([]);

  // –û—Ç–ª–∞–¥–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  useEffect(() => {
    console.log('üîß –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:', {
      selectedRouteIds,
      displayedPolylinesCount: displayedRoutePolylines.length
    });
  }, [selectedRouteIds, displayedRoutePolylines]);
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
  const handleRouteToggle = async (route: RouteData, checked: boolean, mode: 'map' | 'planner') => {
    const info = `üîß handleRouteToggle: ${route.title} (${checked ? '–≤–∫–ª—é—á–∏—Ç—å' : '–≤—ã–∫–ª—é—á–∏—Ç—å'}), —Ç–æ—á–µ–∫: ${route.points?.length || 0} | waypoints: ${route.waypoints?.length || 0} | route_data: ${(route as any).route_data ? '–µ—Å—Ç—å' : '–Ω–µ—Ç'}`;
    setDebugInfo(info);
    
    // –û—á–∏—â–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => setDebugInfo(''), 5000);
    console.log('üîß handleRouteToggle –≤—ã–∑–≤–∞–Ω:', { 
      routeId: route.id, 
      routeTitle: route.title,
      checked, 
      mode,
      pointsCount: route.points?.length || 0,
      points: route.points?.map(p => ({ lat: p.latitude, lon: p.longitude, title: p.title })),
      fullRoutePoints: route.points
    });
    if (mode !== 'planner') return;
    
    if (checked) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –≤ 3 –º–∞—Ä—à—Ä—É—Ç–∞
      if (selectedRouteIds.length >= 3) {
        alert('‚ö†Ô∏è –ú–æ–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –Ω–µ –±–æ–ª–µ–µ 3 –º–∞—Ä—à—Ä—É—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ');
        return;
      }
      
      setSelectedRouteIds(prev => prev.includes(route.id) ? prev : [...prev, route.id]);
      
      // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –ì–ò–î–†–ê–¶–ò–Ø: –µ—Å–ª–∏ route.points –ø—É—Å—Ç–æ–π, –Ω–æ –µ—Å—Ç—å waypoints –∏–ª–∏ route_data
      let hydratedRoute = route;
      if ((!route.points || route.points.length === 0) && ((route.waypoints && route.waypoints.length > 0) || (route as any).route_data)) {
        console.log('üîß –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞:', route.id);
        
        // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ—á–∫–∏ –∏–∑ waypoints
        if (route.waypoints && route.waypoints.length > 0) {
          const byFavId = new Map(favoritePlaces.map(fp => [String(fp.id), fp]));
          const hydratedPoints = route.waypoints
            .map((wp: any) => byFavId.get(String(wp.marker_id)))
            .filter(Boolean)
            .map((m: any, idx: number) => ({
              id: m.id,
              title: m.title || `–¢–æ—á–∫–∞ ${idx + 1}`,
              description: m.description || '',
              latitude: Number(m.coordinates?.[0] ?? NaN),
              longitude: Number(m.coordinates?.[1] ?? NaN)
            }))
            .filter((p: any) => Number.isFinite(p.latitude) && Number.isFinite(p.longitude));
          
          if (hydratedPoints.length > 0) {
            hydratedRoute = { ...route, points: hydratedPoints };
            console.log('üîß –ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –∏–∑ waypoints —É—Å–ø–µ—à–Ω–∞:', hydratedPoints.length, '—Ç–æ—á–µ–∫');
          }
        }
        
        // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∏–∑ waypoints, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑ route_data
        if ((!hydratedRoute.points || hydratedRoute.points.length === 0) && (route as any).route_data) {
          try {
            const rdRaw: any = (route as any).route_data;
            const rd = typeof rdRaw === 'string' ? (JSON.parse(rdRaw) || {}) : (rdRaw || {});
            if (Array.isArray(rd.points) && rd.points.length > 0) {
              const hydratedPoints = rd.points
                .map((p: any, idx: number) => ({
                  id: String(p?.id || `pt-${idx}`),
                  title: p?.title || `–¢–æ—á–∫–∞ ${idx + 1}`,
                  description: p?.description || '',
                  latitude: Number(p?.latitude ?? NaN),
                  longitude: Number(p?.longitude ?? NaN)
                }))
                .filter((p: any) => Number.isFinite(p.latitude) && Number.isFinite(p.longitude));
              
              if (hydratedPoints.length > 0) {
                hydratedRoute = { ...route, points: hydratedPoints };
                console.log('üîß –ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –∏–∑ route_data —É—Å–ø–µ—à–Ω–∞:', hydratedPoints.length, '—Ç–æ—á–µ–∫');
              }
            }
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ route_data:', e);
          }
        }
      }

      // –°—Ç—Ä–æ–∏–º –ø–æ–ª–∏–ª–∏–Ω–∏—é –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞
      if (hydratedRoute.points && hydratedRoute.points.length >= 2) {
        try {
          console.log('üîß –°—Ç—Ä–æ–∏–º –ø–æ–ª–∏–ª–∏–Ω–∏—é –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞:', hydratedRoute.id, hydratedRoute.points);
          // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–æ—á–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç [–¥–æ–ª–≥–æ—Ç–∞, —à–∏—Ä–æ—Ç–∞], —É–±–∏—Ä–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ/–Ω—É–ª–µ–≤—ã–µ
          const toNumber = (v: any) => (v === null || v === undefined ? NaN : Number(v));
          const isFiniteNumber = (n: number) => typeof n === 'number' && Number.isFinite(n);
          const isValidLon = (lon: number) => isFiniteNumber(lon) && lon >= -180 && lon <= 180 && Math.abs(lon) > 0.00001;
          const isValidLat = (lat: number) => isFiniteNumber(lat) && lat >= -90 && lat <= 90 && Math.abs(lat) > 0.00001;
          let normalized = (hydratedRoute.points || [])
            .map(p => [toNumber((p as any).longitude), toNumber((p as any).latitude)] as [number, number])
            .filter(([lon, lat]) => isValidLon(lon) && isValidLat(lat));

          // –§–æ–ª–±—ç–∫-–≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è: –µ—Å–ª–∏ –≤ –º–∞—Ä—à—Ä—É—Ç–µ —Ç–æ—á–∫–∏ –Ω—É–ª–µ–≤—ã–µ, –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏—Ö —Å—Ä–µ–¥–∏ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
          if (normalized.length < 2) {
            try {
              const byId = new Map<string, { lat: number; lon: number }>();
              const byTitle = new Map<string, { lat: number; lon: number }>();
              favoritePlaces.forEach((fav: any) => {
                const lat = Number(fav.coordinates?.[0] ?? fav.latitude);
                const lon = Number(fav.coordinates?.[1] ?? fav.longitude);
                if (isValidLat(lat) && isValidLon(lon)) {
                  if (fav.id) byId.set(String(fav.id), { lat, lon });
                  if (fav.name) byTitle.set(String(fav.name), { lat, lon });
                  if (fav.title) byTitle.set(String(fav.title), { lat, lon });
                }
              });

              const hydrated: [number, number][] = [];
              (hydratedRoute.points || []).forEach((p: any) => {
                const pid = p.id ? String(p.id) : '';
                const ptitle = p.title ? String(p.title) : '';
                let coord = pid && byId.get(pid);
                if (!coord && ptitle) coord = byTitle.get(ptitle);
                if (coord && isValidLat(coord.lat) && isValidLon(coord.lon)) {
                  hydrated.push([coord.lon, coord.lat]);
                }
              });
              if (hydrated.length >= 2) normalized = hydrated;
            } catch {}
          }

          if (normalized.length < 2) {
            console.warn('–ú–∞—Ä—à—Ä—É—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ—á–µ–∫ –¥–ª—è ORS', { count: normalized.length, routeId: route.id });
            return;
          }

          console.log('üîß –¢–æ—á–∫–∏ –¥–ª—è –ø–æ–ª–∏–ª–∏–Ω–∏–∏ (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ):', normalized);
          console.log('üîß –ò—Å—Ö–æ–¥–Ω—ã–µ hydratedRoute.points:', hydratedRoute.points?.map(p => ({ id: p.id, lat: p.latitude, lon: p.longitude, title: p.title })));
          setDebugInfo(prev => prev + ` | –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ: ${normalized.length} —Ç–æ—á–µ–∫`);

          // 1) –°—Ä–∞–∑—É –æ—Ç–æ–±—Ä–∞–∑–∏–º —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞: –¥–æ–±–∞–≤–∏–º –∏—Ö –≤ –µ–¥–∏–Ω—É—é —Å–∏—Å—Ç–µ–º—É —Ç–æ—á–µ–∫
          // —á–µ—Ä–µ–∑ pointManager (–∏–º–µ–Ω–Ω–æ –∏–∑ activePoints —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –º–∞—Ä–∫–µ—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ)
          const routeMarkersToAdd = normalized.map(([lon, lat], index) => ({
            id: String((hydratedRoute.points?.[index] as any)?.id || `route-${hydratedRoute.id}-point-${index}`),
            coordinates: [lat, lon] as [number, number], // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: Yandex Maps –æ–∂–∏–¥–∞–µ—Ç [—à–∏—Ä–æ—Ç–∞, –¥–æ–ª–≥–æ—Ç–∞]
            title: (hydratedRoute.points?.[index] as any)?.title || `–¢–æ—á–∫–∞ ${index + 1}`,
            description: (hydratedRoute.points?.[index] as any)?.description || `–ò–∑ –º–∞—Ä—à—Ä—É—Ç–∞: ${hydratedRoute.title}`,
          }));
          
          console.log('üîß –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞:', {
            routeId: hydratedRoute.id,
            markersToAdd: routeMarkersToAdd.map(m => ({ id: m.id, coords: m.coordinates, title: m.title }))
          });
          // –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ä—ã–µ —Ç–æ—á–∫–∏ —ç—Ç–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ
          try { pointManager.removePointBySource('route', hydratedRoute.id); } catch {}
          try {
            routeMarkersToAdd.forEach(m => {
              pointManager.addPoint({
                coordinates: [m.coordinates[0], m.coordinates[1]], // [lat, lon] - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è pointManager
                title: m.title,
                description: m.description,
                source: 'route',
                sourceId: `${hydratedRoute.id}:${m.id}`
              });
            });
          } catch {}
          // –ü–æ–¥–¥–µ—Ä–∂–∏–º —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
          setMapClickMarkers(prev => {
            const existing = new Set(prev.map(m => m.id));
            const merged = [...prev];
            for (const m of routeMarkersToAdd) {
              if (!existing.has(m.id)) merged.push(m);
            }
            return merged;
          });

          const polyline = await getRoutePolyline(normalized);
          console.log('üîß –ü–æ–ª—É—á–µ–Ω–∞ –ø–æ–ª–∏–ª–∏–Ω–∏—è:', polyline.length, '—Ç–æ—á–µ–∫');
          
          const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1']; // –†–∞–∑–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
          const color = colors[(selectedRouteIds.length + 1) % colors.length]; // +1 –ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏ —Ç–µ–∫—É—â–∏–π ID
          
          console.log('üîß –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏–ª–∏–Ω–∏—é –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', { id: hydratedRoute.id, color, pointsCount: polyline.length });
          setDisplayedRoutePolylines(prev => [...prev, {
            id: hydratedRoute.id,
            polyline,
            color
          }]);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ–ª–∏–ª–∏–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞, —Ä–∏—Å—É–µ–º –ø—Ä—è–º—É—é –ª–∏–Ω–∏—é:', error);
          // –§–æ–ª–±—ç–∫: —Ä–∏—Å—É–µ–º –ø—Ä–æ—Å—Ç—É—é –ª–∏–Ω–∏—é –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏ [lat,lon]
          const fallbackPolyline: [number, number][] = (hydratedRoute.points || [])
            .map((p: any) => [Number(p.longitude), Number(p.latitude)] as [number, number])
            .filter(([lon, lat]: [number, number]) => Number.isFinite(lon) && Number.isFinite(lat))
            .map(([lon, lat]: [number, number]) => [lat, lon] as [number, number]);
          const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1'];
          const color = colors[(selectedRouteIds.length + 1) % colors.length];
          setDisplayedRoutePolylines(prev => [...prev, { id: hydratedRoute.id, polyline: fallbackPolyline, color }]);
        }
      } else {
        console.log('üîß –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–µ–∫ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞:', hydratedRoute.points?.length || 0);
      }
    } else {
      // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –ì–ò–î–†–ê–¶–ò–Ø –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: –µ—Å–ª–∏ route.points –ø—É—Å—Ç–æ–π, –Ω–æ –µ—Å—Ç—å waypoints –∏–ª–∏ route_data
      let hydratedRouteForRemoval = route;
      if ((!route.points || route.points.length === 0) && ((route.waypoints && route.waypoints.length > 0) || (route as any).route_data)) {
        console.log('üîß –ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞:', route.id);
        
        // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ—á–∫–∏ –∏–∑ waypoints
        if (route.waypoints && route.waypoints.length > 0) {
          const byFavId = new Map(favoritePlaces.map(fp => [String(fp.id), fp]));
          const hydratedPoints = route.waypoints
            .map((wp: any) => byFavId.get(String(wp.marker_id)))
            .filter(Boolean)
            .map((m: any, idx: number) => ({
              id: m.id,
              title: m.title || `–¢–æ—á–∫–∞ ${idx + 1}`,
              description: m.description || '',
              latitude: Number(m.coordinates?.[0] ?? NaN),
              longitude: Number(m.coordinates?.[1] ?? NaN)
            }))
            .filter((p: any) => Number.isFinite(p.latitude) && Number.isFinite(p.longitude));
          
          if (hydratedPoints.length > 0) {
            hydratedRouteForRemoval = { ...route, points: hydratedPoints };
            console.log('üîß –ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ waypoints —É—Å–ø–µ—à–Ω–∞:', hydratedPoints.length, '—Ç–æ—á–µ–∫');
          }
        }
        
        // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∏–∑ waypoints, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑ route_data
        if ((!hydratedRouteForRemoval.points || hydratedRouteForRemoval.points.length === 0) && (route as any).route_data) {
          try {
            const rdRaw: any = (route as any).route_data;
            const rd = typeof rdRaw === 'string' ? (JSON.parse(rdRaw) || {}) : (rdRaw || {});
            if (Array.isArray(rd.points) && rd.points.length > 0) {
              const hydratedPoints = rd.points
                .map((p: any, idx: number) => ({
                  id: String(p?.id || `pt-${idx}`),
                  title: p?.title || `–¢–æ—á–∫–∞ ${idx + 1}`,
                  description: p?.description || '',
                  latitude: Number(p?.latitude ?? NaN),
                  longitude: Number(p?.longitude ?? NaN)
                }))
                .filter((p: any) => Number.isFinite(p.latitude) && Number.isFinite(p.longitude));
              
              if (hydratedPoints.length > 0) {
                hydratedRouteForRemoval = { ...route, points: hydratedPoints };
                console.log('üîß –ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ route_data —É—Å–ø–µ—à–Ω–∞:', hydratedPoints.length, '—Ç–æ—á–µ–∫');
              }
            }
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ route_data –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:', e);
          }
        }
      }

      console.log('üîß –°–Ω–∏–º–∞–µ–º —á–µ–∫–±–æ–∫—Å –º–∞—Ä—à—Ä—É—Ç–∞, —É–¥–∞–ª—è–µ–º –º–µ—Ç–∫–∏:', {
        routeId: route.id,
        routePoints: hydratedRouteForRemoval.points?.map(p => ({ id: p.id, title: p.title })),
        currentSelectedRouteIds: selectedRouteIds,
        currentDisplayedPolylines: displayedRoutePolylines.length
      });
      
      setSelectedRouteIds(prev => {
        const newIds = prev.filter(id => id !== route.id);
        console.log('üîß –û–±–Ω–æ–≤–ª—è–µ–º selectedRouteIds:', { –±—ã–ª–æ: prev, —Å—Ç–∞–ª–æ: newIds });
        return newIds;
      });
      setDisplayedRoutePolylines(prev => {
        const newPolylines = prev.filter(r => r.id !== route.id);
        console.log('üîß –û–±–Ω–æ–≤–ª—è–µ–º displayedRoutePolylines:', { –±—ã–ª–æ: prev.length, —Å—Ç–∞–ª–æ: newPolylines.length });
        return newPolylines;
      });
      
      // –í–ê–ñ–ù–û: –¢–∞–∫–∂–µ –æ—á–∏—â–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –ø–æ–ª–∏–ª–∏–Ω–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –∏–∑ —ç—Ç–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∞—è routePolyline —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º —ç—Ç–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
      if (routePolyline.length > 0) {
        console.log('üîß –û—á–∏—â–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é routePolyline –ø—Ä–∏ —Å–Ω—è—Ç–∏–∏ —á–µ–∫–±–æ–∫—Å–∞ –º–∞—Ä—à—Ä—É—Ç–∞');
        setRoutePolyline([]);
      }
      
      // –¢–∞–∫–∂–µ –æ—á–∏—â–∞–µ–º unifiedRoutePolyline —á–µ—Ä–µ–∑ pointManager.clearRoute()
      console.log('üîß –û—á–∏—â–∞–µ–º unifiedRoutePolyline —á–µ—Ä–µ–∑ pointManager.clearRoute()');
      pointManager.clearRoute();
      
      // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–∏–¥—Ä–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏)
      setMapClickMarkers(prev => {
        const toRemove = (hydratedRouteForRemoval.points || []).map((p: any, idx: number) => String(p?.id || `route-${route.id}-point-${idx}`));
        console.log('üîß –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫–∏ —Å ID:', toRemove);
        return prev.filter(m => !toRemove.includes(m.id));
      });
      // –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ –∏–∑ –µ–¥–∏–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (–∏–º–µ–Ω–Ω–æ –æ–Ω–∏ —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–µ)
      // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–æ—á–∫–∏ —ç—Ç–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É sourceId
      try { 
        const pointsToRemove = activePoints.filter(p => p.source === 'route' && p.sourceId?.startsWith(`${route.id}:`));
        console.log('üîß –£–¥–∞–ª—è–µ–º —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ –∏–∑ –µ–¥–∏–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã:', {
          routeId: route.id,
          pointsToRemove: pointsToRemove.map(p => ({ id: p.id, sourceId: p.sourceId, title: p.title })),
          totalActivePoints: activePoints.length
        });
        pointsToRemove.forEach(p => {
          console.log('üîß –£–¥–∞–ª—è–µ–º —Ç–æ—á–∫—É:', p.id);
          pointManager.removePoint(p.id);
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
      }
    }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫ - –µ–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
  const handleMapClick = (coordinates: [number, number]) => {
    try {
      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—É—é —Å–∏—Å—Ç–µ–º—É
      pointManager.addClickPoint(coordinates);
      
      console.log('üîß handleMapClick:', {
        coordinates,
        activePointsCount: activePoints.length,
        canBuild,
        activePoints: activePoints.map(p => ({ id: p.id, title: p.title, source: p.source, isActive: p.isActive }))
      });
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–µ–∫
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
      setTimeout(() => {
        if (canBuild) {
          pointManager.buildRoute().catch(error => {
            console.warn('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞:', error);
          });
        }
      }, 150);
      
      // –í–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ alert
      const inspirationMessages = [
        "‚ú® –û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä! –≠—Ç–∞ —Ç–æ—á–∫–∞ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –Ω–∞—á–∞–ª–æ–º —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞",
        "üåç –ö–∞–∂–¥–æ–µ –º–µ—Å—Ç–æ –∏–º–µ–µ—Ç —Å–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é. –ß—Ç–æ –≤—ã –∑–¥–µ—Å—å —É–≤–∏–¥–µ–ª–∏?",
        "üéØ –•–æ—Ä–æ—à–æ! –¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤—å—Ç–µ –µ—â—ë –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–æ—á–µ–∫, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ",
        "üí´ –ö—Ä–∞—Å–∏–≤–æ–µ –º–µ—Å—Ç–æ! –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å –¥—Ä—É–≥–∏–º–∏, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –µ–≥–æ –æ—Å–æ–±–µ–Ω–Ω—ã–º"
      ];
      
      const message = inspirationMessages[Math.floor(Math.random() * inspirationMessages.length)];
      const lat = coordinates[0] || 0;
      const lng = coordinates[1] || 0;
      alert(`‚úÖ ${message}\n\n–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: [${lat.toFixed(4)}, ${lng.toFixed(4)}]\n\n–ú–µ—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–∞ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞.\n\nüí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –º–µ—Ç–∫–µ, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –µ—ë.`);
    } catch (error) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ message channel (–æ–±—ã—á–Ω–æ –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä–∞)
      console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ:', error);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ –∏–∑ –µ–¥–∏–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
  const handleRemoveMarker = (markerId: string) => {
    try {
      // –£–¥–∞–ª—è–µ–º —Ç–æ—á–∫—É –∏–∑ –µ–¥–∏–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
      pointManager.removePoint(markerId);
      console.log('üóëÔ∏è –ú–∞—Ä–∫–µ—Ä —É–¥–∞–ª–µ–Ω:', markerId);
    } catch (error) {
      console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–∞—Ä–∫–µ—Ä–∞:', error);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏, –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–π –∫–ª–∏–∫–æ–º - –Ω–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
  const handleRemoveClickMarker = (markerId: string) => {
    setMapClickMarkers((prev: typeof mapClickMarkers) => prev.filter(marker => marker.id !== markerId));
    setSelectedMarkerIds((prev: string[]) => (prev || []).filter((id: string) => id !== markerId));
    // –£–¥–∞–ª—è–µ–º —Ç–æ—á–∫—É –∏–∑ –µ–¥–∏–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
    try { pointManager.removePoint(markerId); } catch {}
  };

  // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
  useEffect(() => {
    registerPanel();
    return () => unregisterPanel();
  }, [registerPanel, unregisterPanel]);

  return (
    <MirrorGradientContainer>
      <div className="page-container">
        <div className="page-content">
          {/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */}
          <div className="h-full relative">
            <div className="map-content-container">
              {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */}
              <StableHeader 
                showZonesLayer={showZonesLayer} 
                setShowZonesLayer={setShowZonesLayer}
                currentProvider={currentMapProvider}
                setCurrentProvider={setCurrentMapProvider}
              />

              {/* –û–±–ª–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */}
              <div className="map-area">
                <div className="full-height-content relative">
                  {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã */}
                  {!isMapReady && (
                    <div className="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center z-10">
                      <div className="text-center">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p className="text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</p>
                      </div>
                    </div>
                  )}
                  
                  {/* –ö–∞—Ä—Ç–∞ —á–µ—Ä–µ–∑ —Ñ–∞—Å–∞–¥ */}
                  <FacadeMap 
                    onMapReady={() => setIsMapReady(true)}
                    onMapClick={handleMapClick}
                    markers={facadeMarkers}
                    routes={facadeRoutes}
                    provider={currentMapProvider}
                  />
                </div>
              </div>
            </div>

            {/* –õ–µ–≤–∞—è –≤—ã–¥–≤–∏–≥–∞—é—â–∞—è—Å—è –ø–∞–Ω–µ–ª—å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ */}
            <div className={`page-slide-panel left ${false ? 'open' : ''}`}>
              <div className="page-slide-panel-content">
                <div className="w-full h-full flex flex-col">
                  <PlannerAccordion
                    onBuildRoute={() => {}}
                    activePoints={activePoints}
                    onRemovePoint={pointManager.removePoint}
                    onTogglePoint={pointManager.togglePoint}
                    onReorderPoints={pointManager.reorderPoints}
                    onAddSearchPoint={() => {}}
                    onBuildRouteFromPoints={pointManager.buildRoute}
                    canBuildRoute={canBuild}
                    isBuilding={isBuilding}
                    routeStats={stats}
                  />
                </div>
              </div>
            </div>

            {/* –ü—Ä–∞–≤–∞—è –≤—ã–¥–≤–∏–≥–∞—é—â–∞—è—Å—è –ø–∞–Ω–µ–ª—å —Å –∏–∑–±—Ä–∞–Ω–Ω—ã–º */}
            <div className={`page-slide-panel right ${false ? 'open' : ''}`}>
              <div className="page-slide-panel-content">
                <FavoritesPanel
                  favorites={(favorites as any)?.favoritePlaces || []}
                  routes={(favorites as any)?.favoriteRoutes || []}
                  mode="planner"
                  isVip={false}
                  onRemove={() => {}}
                  onClose={() => {}}
                  onBuildRoute={() => {}}
                  onMoveToPlanner={handleMoveToPlanner}
                  onLoadRoute={() => {}}
                  selectedMarkerIds={[]}
                  onSelectedMarkersChange={() => {}}
                  onMoveToMap={() => {}}
                  selectedRouteIds={[]}
                  onSelectedRouteIdsChange={() => {}}
                />
              </div>
            </div>
          </div>
        </div>
      </div>
    </MirrorGradientContainer>
  );
};

export default Planner;