import React, { useEffect, useRef, useState } from 'react';
import { yandexMapsService } from '../../services/yandexMapsService';

interface YandexMapProps {
  center: [number, number];
  zoom: number;
  markers?: Array<{
    id: number;
    coordinates: [number, number];
    title: string;
    description?: string;
  }>;
  onMapClick?: (coordinates: [number, number]) => void;
  routeLine?: [number, number][];
}

const YandexMap: React.FC<YandexMapProps> = ({ center, zoom, markers = [], onMapClick, routeLine }) => {
  const mapRef = useRef<HTMLDivElement>(null);
  const mapInstanceRef = useRef<any>(null);
  const markersRef = useRef<any[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [isMapReady, setIsMapReady] = useState(false);

  // useEffect для инициализации карты
  useEffect(() => {
    let destroyed = false;

    const initMap = async () => {
      try {
        setIsLoading(true);
        setError(null);

        // Инициализация сервиса Яндекс Карт
        await yandexMapsService.init();

        if (!window.ymaps) {
          throw new Error('Yandex Maps API не загружен');
        }

        if (!mapRef.current) {
          throw new Error('mapRef.current не найден!');
        }

        // Уничтожаем предыдущий экземпляр карты, если он есть
        if (mapInstanceRef.current) {
          mapInstanceRef.current.destroy();
          mapInstanceRef.current = null;
        }

        // Создание карты
        mapInstanceRef.current = new window.ymaps.Map(mapRef.current, {
          center: center,
          zoom,
          controls: ['zoomControl', 'fullscreenControl']
        });

        // Добавление обработчика клика по карте
        if (onMapClick) {
          mapInstanceRef.current.events.add('click', (e: any) => {
            const coords = e.get('coords') as [number, number];
            onMapClick(coords);
          });
        }

        if (!destroyed) {
          setIsLoading(false);
          setIsMapReady(true);
        }
      } catch (err) {
        if (!destroyed) {
          setError('Не удалось загрузить карту. Пожалуйста, обновите страницу.');
          setIsLoading(false);
        }
      }
    };

    initMap();

    return () => {
      destroyed = true;
      if (mapInstanceRef.current) {
        mapInstanceRef.current.destroy();
        mapInstanceRef.current = null;
      }
    };
  }, []);

  // useEffect для смены центра и zoom
  useEffect(() => {
    if (mapInstanceRef.current && window.ymaps) {
      mapInstanceRef.current.setCenter(center, zoom);
    }
  }, [center, zoom]);

  // Обновление маркеров
  useEffect(() => {
    if (!isMapReady || !mapInstanceRef.current) {
      return;
    }

    // Удаление старых маркеров
    markersRef.current.forEach(marker => {
      try {
        mapInstanceRef.current.geoObjects.remove(marker);
      } catch (error) {
        console.error('Ошибка при удалении маркера:', error);
      }
    });
    markersRef.current = [];

    // Добавление новых маркеров
    markers.forEach((marker, idx) => {
      try {
        const markerInstance = new window.ymaps.Placemark(
          marker.coordinates,
          {
            balloonContent: `<div class="marker-popup"><h3>${marker.title}</h3>${marker.description ? `<p>${marker.description}</p>` : ''}</div>`,
          },
          { preset: 'islands#blueStretchyIcon' }
        );
        mapInstanceRef.current.geoObjects.add(markerInstance);
        markersRef.current.push(markerInstance);
      } catch (error) {
        console.error(`Ошибка при добавлении маркера #${idx}:`, error);
      }
    });
  }, [markers, isMapReady]);

  // Обновление линии маршрута
  useEffect(() => {
    if (!mapInstanceRef.current || !window.ymaps) {
      return;
    }
    
    // Удаляем старую линию маршрута, если есть
    if (mapInstanceRef.current.routeLine) {
      mapInstanceRef.current.geoObjects.remove(mapInstanceRef.current.routeLine);
      mapInstanceRef.current.routeLine = null;
    }

    if (routeLine && routeLine.length > 1) {
      const polyline = new window.ymaps.Polyline(routeLine, {}, {
        strokeColor: '#3B82F6',
        strokeWidth: 5,
        opacity: 0.7,
      });
      mapInstanceRef.current.geoObjects.add(polyline);
      mapInstanceRef.current.routeLine = polyline;
    }
  }, [routeLine]);

  return (
    <div style={{ position: 'relative', width: '100%', height: '100%', minHeight: '500px' }}>
      {isLoading && (
        <div style={{
          position: 'absolute',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          backgroundColor: 'rgba(255, 255, 255, 0.8)',
          zIndex: 1000
        }}>
          <div className="text-lg font-semibold">Загрузка карты...</div>
        </div>
      )}
      
      {error && (
        <div style={{
          position: 'absolute',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          backgroundColor: 'rgba(255, 255, 255, 0.9)',
          zIndex: 1000
        }}>
          <div className="text-red-600 text-lg font-semibold">{error}</div>
        </div>
      )}
      
      <div ref={mapRef} style={{ width: '100%', height: '100%' }} />
    </div>
  );
};

export default YandexMap; 