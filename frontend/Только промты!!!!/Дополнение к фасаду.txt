–ü–û–õ–ù–´–ô –ü–†–û–ú–¢ –î–õ–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–ò: –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ö–ê–†–¢–û–ì–†–ê–§–ò–ß–ï–°–ö–ò–ô –§–ê–°–ê–î (PRODUCTION GRADE)
üîπ –û–ë–©–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø
–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å MapContextFacade ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º–∏ –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–º–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è–º–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ì–µ–æ–ë–ª–æ–≥.—Ä—Ñ. –§–∞—Å–∞–¥ –¥–æ–ª–∂–µ–Ω:

–ö–æ–æ—Ä–¥–∏–Ω–∏—Ä–æ–≤–∞—Ç—å 4 –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–æ –≤—Å–µ–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ (–≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è, –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞)

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

–ë—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã–º

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∞–≤–∞—Ä–∏–π–Ω—É—é –∑–∞–º–µ–Ω—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –∫–∞—Ä—Ç

üì¶ 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô
typescript
interface MapFacadeDependencies {
  // –û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
  gamificationFacade: GamificationFacade;
  eventsStore: EventsStore;
  activityService: ActivityService;
  offlineContentQueue: OfflineContentQueue;
  analyticsOrchestrator: AnalyticsOrchestrator;
  moderationService: ModerationService;
  accessControlService: AccessControlService;
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã
  userService: UserService;          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π (premium/free)
  notificationService: NotificationService; // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (XP, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è, –æ—à–∏–±–∫–∏)
  searchService: SearchService;      // –ì–µ–æ–ø–æ–∏—Å–∫ (Nominatim + –æ—Ñ–ª–∞–π–Ω-–∫—ç—à)
  storageService: StorageService;    // IndexedDB –¥–ª—è –æ—Ñ–ª–∞–π–Ω-–¥–∞–Ω–Ω—ã—Ö
  markerService: MarkerService;      // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
  routeService: RouteService;        // –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤
}

class MapContextFacade {
  private dependencies: MapFacadeDependencies;
  
  constructor(dependencies: MapFacadeDependencies) {
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    const requiredServices = [
      'userService', 'gamificationFacade', 'offlineContentQueue'
    ];
    
    requiredServices.forEach(service => {
      if (!dependencies[service as keyof MapFacadeDependencies]) {
        throw new Error(`${service} is required for MapContextFacade`);
      }
    });
    
    this.dependencies = dependencies;
    this.initialize();
  }
  
  private initialize(): void {
    this.setupAnalytics();
    this.setupOfflineSync();
    this.setupErrorHandling();
  }
}
üéÆ 2. –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° –ì–ï–ô–ú–ò–§–ò–ö–ê–¶–ò–ï–ô (–° –ó–ê–©–ò–¢–û–ô –û–¢ –ù–ê–ö–†–£–¢–û–ö)
typescript
interface XPResult {
  xpAdded: number;
  levelUp: boolean;
  newLevel?: number;
  achievementUnlocked?: boolean;
}

interface ActionLimit {
  action: string;
  dailyLimit: number;
  perHourLimit: number;
}

class MapContextFacade {
  // –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–æ–≤
  private async checkActionLimits(action: string, userId: string): Promise<{ allowed: boolean; message?: string }> {
    const limits: Record<string, ActionLimit> = {
      'create_marker': { action: 'create_marker', dailyLimit: 50, perHourLimit: 10 },
      'create_post': { action: 'create_post', dailyLimit: 20, perHourLimit: 5 },
      'add_to_favorites': { action: 'add_to_favorites', dailyLimit: 100, perHourLimit: 30 }
    };
    
    const limit = limits[action];
    if (!limit) return { allowed: true };
    
    const stats = await this.dependencies.gamificationFacade.getActionStats(userId, action);
    
    if (stats.dailyCount >= limit.dailyLimit) {
      return { allowed: false, message: `–î–æ—Å—Ç–∏–≥–Ω—É—Ç –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –¥–ª—è ${action}` };
    }
    
    if (stats.hourlyCount >= limit.perHourLimit) {
      return { allowed: false, message: `–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å` };
    }
    
    return { allowed: true };
  }
  
  // –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π —Å –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
  async registerGamifiedAction(
    action: 'create_marker' | 'create_post' | 'add_to_favorites' | 'complete_route',
    metadata?: {
      hasPhoto?: boolean;
      hasDescription?: boolean;
      quality?: 'low' | 'medium' | 'high' | 'excellent';
      coordinates?: [number, number];
    }
  ): Promise<XPResult> {
    const user = this.dependencies.userService.getCurrentUser();
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤
    const limitCheck = await this.checkActionLimits(action, user.id);
    if (!limitCheck.allowed) {
      throw new Error(`Limit exceeded for ${action}: ${limitCheck.message}`);
    }
    
    // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ XP
    const xpResult = await this.dependencies.gamificationFacade.awardXP(action, {
      userId: user.id,
      ...metadata
    });
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (xpResult.xpAdded > 0) {
      this.dependencies.notificationService.notify({
        type: 'xp_awarded',
        title: '–ü–æ–ª—É—á–µ–Ω –æ–ø—ã—Ç!',
        message: `+${xpResult.xpAdded} XP –∑–∞ –¥–µ–π—Å—Ç–≤–∏–µ`,
        data: { action, xpAdded: xpResult.xpAdded }
      });
    }
    
    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    await this.logActivity(`gamification_${action}`, {
      userId: user.id,
      xpAdded: xpResult.xpAdded,
      levelUp: xpResult.levelChanged,
      metadata
    });
    
    return {
      xpAdded: xpResult.amount,
      levelUp: xpResult.levelChanged,
      newLevel: xpResult.newLevel,
      achievementUnlocked: xpResult.achievementUnlocked
    };
  }
}
üìÖ 3. –†–ê–ë–û–¢–ê –° –°–û–ë–´–¢–ò–Ø–ú–ò –ö–ê–õ–ï–ù–î–ê–†–Ø (–° –û–§–§–õ–ê–ô–ù-–ö–≠–®–ï–ú)
typescript
interface CalendarEvent {
  id: string;
  title: string;
  description: string;
  startDate: Date;
  endDate: Date;
  location: {
    coordinates: [number, number];
    address?: string;
  };
  category: {
    id: string;
    name: string;
    color: string;
    icon: string;
  };
  isRecurring?: boolean;
}

interface MapBounds {
  north: number;
  south: number;
  east: number;
  west: number;
}

class MapContextFacade {
  private cachedEvents: Map<string, CalendarEvent[]> = new Map();
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –≥—Ä–∞–Ω–∏—Ü–∞–º –∫–∞—Ä—Ç—ã
  async getEventsForMap(
    dateRange: { start: Date; end: Date },
    bounds?: MapBounds,
    options?: {
      includeOffline?: boolean;
      categories?: string[];
    }
  ): Promise<CalendarEvent[]> {
    const cacheKey = `${dateRange.start.getTime()}-${dateRange.end.getTime()}`;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
    if (options?.includeOffline && this.cachedEvents.has(cacheKey)) {
      const cached = this.cachedEvents.get(cacheKey)!;
      return this.filterEventsByBounds(cached, bounds, options.categories);
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ eventsStore
    let events = await this.dependencies.eventsStore.getEvents(dateRange);
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    if (options?.categories?.length) {
      events = events.filter(event => 
        options.categories!.includes(event.category.id)
      );
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à –¥–ª—è –æ—Ñ–ª–∞–π–Ω
    if (options?.includeOffline) {
      this.cachedEvents.set(cacheKey, events);
      await this.dependencies.storageService.setItem(
        `cached_events_${cacheKey}`,
        events,
        { ttl: 24 * 60 * 60 * 1000 } // 24 —á–∞—Å–∞
      );
    }
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≥—Ä–∞–Ω–∏—Ü–∞–º –∫–∞—Ä—Ç—ã
    return this.filterEventsByBounds(events, bounds);
  }
  
  private filterEventsByBounds(
    events: CalendarEvent[],
    bounds?: MapBounds,
    categories?: string[]
  ): CalendarEvent[] {
    if (!bounds) return events;
    
    return events.filter(event => {
      const [lng, lat] = event.location.coordinates;
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –≥—Ä–∞–Ω–∏—Ü—ã
      const withinBounds = 
        lat >= bounds.south && 
        lat <= bounds.north && 
        lng >= bounds.west && 
        lng <= bounds.east;
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
      const matchesCategory = !categories?.length || 
        categories.includes(event.category.id);
      
      return withinBounds && matchesCategory;
    });
  }
  
  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ (–ø—É–ª—å—Å–∞—Ü–∏—è)
  async highlightEventOnMap(eventId: string, options?: {
    duration?: number;
    color?: string;
  }): Promise<void> {
    const event = await this.dependencies.eventsStore.getEventById(eventId);
    if (!event) throw new Error(`Event ${eventId} not found`);
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∫–∞—Ä—Ç—ã
    const mapInstance = this.getActiveMapInstance();
    if (!mapInstance) return;
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –ø—É–ª—å—Å–∏—Ä—É—é—â–µ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
    const marker = this.createEventMarker(event, {
      pulsating: true,
      pulseColor: options?.color || event.category.color,
      pulseDuration: options?.duration || 3000
    });
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
    mapInstance.addMarker(marker);
    
    // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –Ω–∞ —Å–æ–±—ã—Ç–∏–∏
    mapInstance.setView(event.location.coordinates, 14);
    
    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    await this.logActivity('highlight_event', {
      eventId,
      eventTitle: event.title,
      coordinates: event.location.coordinates
    });
  }
  
  // –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ —Å–æ–±—ã—Ç–∏—è (–∫—Ä—É–≥–ª—ã–π —Å –∏–∫–æ–Ω–∫–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—è)
  private createEventMarker(
    event: CalendarEvent,
    options?: {
      pulsating?: boolean;
      pulseColor?: string;
      pulseDuration?: number;
    }
  ): UnifiedMarker {
    return {
      id: `event_${event.id}`,
      type: 'event',
      coordinates: event.location.coordinates,
      title: event.title,
      icon: {
        url: '/icons/calendar-marker.svg',
        size: [32, 32],
        anchor: [16, 16]
      },
      color: event.category.color,
      popupContent: this.renderEventPopup(event),
      animation: options?.pulsating ? 'pulse' : undefined,
      metadata: {
        eventId: event.id,
        category: event.category,
        startDate: event.startDate,
        endDate: event.endDate
      }
    };
  }
  
  private renderEventPopup(event: CalendarEvent): React.ReactNode {
    // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–π –ø–æ–ø–∞–ø –¥–ª—è —Å–æ–±—ã—Ç–∏—è
    return (
      <div className="glassmorphism-popup">
        <h3>{event.title}</h3>
        <p>{event.description}</p>
        <div className="event-category" style={{ color: event.category.color }}>
          {event.category.name}
        </div>
        <button onClick={() => this.navigateToEvent(event.id)}>
          –ü–æ–¥—Ä–æ–±–Ω–µ–µ
        </button>
      </div>
    );
  }
}
üìä 4. –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ê–ö–¢–ò–í–ù–û–°–¢–ò (–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï)
typescript
interface ActivityLog {
  type: string;
  userId: string;
  timestamp: number;
  details: Record<string, any>;
  context?: 'map' | 'planner' | 'post' | 'offline';
}

class MapContextFacade {
  private activityQueue: ActivityLog[] = [];
  private readonly MAX_QUEUE_SIZE = 100;
  
  // –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
  private async logActivity(
    type: string,
    details: Record<string, any>,
    context?: string
  ): Promise<void> {
    const user = this.dependencies.userService.getCurrentUser();
    
    const log: ActivityLog = {
      type,
      userId: user.id,
      timestamp: Date.now(),
      details,
      context: context as any
    };
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å
    this.activityQueue.push(log);
    
    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏
    if (this.activityQueue.length > this.MAX_QUEUE_SIZE) {
      this.activityQueue.shift();
    }
    
    // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI)
    this.sendActivityLog(log).catch(error => {
      console.warn('Failed to send activity log:', error);
      this.dependencies.analyticsOrchestrator.trackError('activity_log_failed', error);
    });
  }
  
  private async sendActivityLog(log: ActivityLog): Promise<void> {
    // –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Å–µ—Ä–≤–∏—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    await this.dependencies.activityService.recordActivity(log);
    
    // –¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫—É
    this.dependencies.analyticsOrchestrator.trackBehavior({
      type: `map_${log.type}`,
      userId: log.userId,
      timestamp: log.timestamp,
      metadata: log.details
    });
  }
  
  // –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
  async createMarker(markerData: DraftMarker): Promise<string> {
    try {
      await this.logActivity('marker_create_start', { markerData });
      
      // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
      const markerId = await this.dependencies.markerService.create(markerData);
      
      // –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è
      await this.registerGamifiedAction('create_marker', {
        hasPhoto: !!markerData.photo,
        hasDescription: !!markerData.description,
        coordinates: markerData.coordinates
      });
      
      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—Ö–∞
      await this.logActivity('marker_create_success', { markerId });
      
      return markerId;
    } catch (error) {
      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
      await this.logActivity('marker_create_error', { error: error.message });
      throw error;
    }
  }
}
üì± 5. –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –û–§–§–õ–ê–ô–ù-–†–ï–ñ–ò–ú
typescript
interface OfflineDraft {
  id: string;
  type: 'post' | 'marker' | 'route' | 'event';
  data: any;
  createdAt: number;
  updatedAt: number;
  syncStatus: 'pending' | 'syncing' | 'failed' | 'synced';
  retryCount: number;
  lastError?: string;
}

interface SyncResult {
  total: number;
  success: number;
  failed: number;
  errors: Array<{ id: string; error: string }>;
}

class MapContextFacade {
  private syncInProgress = false;
  private readonly MAX_RETRY_COUNT = 3;
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –≤ –æ—Ñ–ª–∞–π–Ω
  async saveOfflineDraft(
    type: OfflineDraft['type'],
    data: any
  ): Promise<string> {
    const user = this.dependencies.userService.getCurrentUser();
    
    const draft: OfflineDraft = {
      id: `${type}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      type,
      data,
      createdAt: Date.now(),
      updatedAt: Date.now(),
      syncStatus: 'pending',
      retryCount: 0
    };
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ IndexedDB
    await this.dependencies.offlineContentQueue.add(draft);
    
    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    await this.logActivity('offline_draft_saved', {
      draftId: draft.id,
      type,
      dataSize: JSON.stringify(data).length
    });
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    this.dependencies.notificationService.notify({
      type: 'draft_saved',
      title: '–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω',
      message: `–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –¥–ª—è –æ—Ñ–ª–∞–π–Ω-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏`,
      duration: 3000
    });
    
    return draft.id;
  }
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
  async getOfflineDrafts(
    type?: OfflineDraft['type'],
    status?: OfflineDraft['syncStatus']
  ): Promise<OfflineDraft[]> {
    const drafts = await this.dependencies.offlineContentQueue.getAll();
    
    let filtered = drafts;
    
    if (type) {
      filtered = filtered.filter(draft => draft.type === type);
    }
    
    if (status) {
      filtered = filtered.filter(draft => draft.syncStatus === status);
    }
    
    return filtered.sort((a, b) => b.createdAt - a.createdAt);
  }
  
  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
  async syncAllDrafts(): Promise<SyncResult> {
    if (this.syncInProgress) {
      throw new Error('Sync already in progress');
    }
    
    this.syncInProgress = true;
    
    try {
      const drafts = await this.getOfflineDrafts(undefined, 'pending');
      const result: SyncResult = {
        total: drafts.length,
        success: 0,
        failed: 0,
        errors: []
      };
      
      // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      this.dependencies.notificationService.notify({
        type: 'sync_start',
        title: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è',
        message: `–ù–∞—á–∏–Ω–∞—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é ${drafts.length} —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤`
      });
      
      for (const draft of drafts) {
        try {
          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
          draft.syncStatus = 'syncing';
          draft.updatedAt = Date.now();
          await this.dependencies.offlineContentQueue.update(draft);
          
          // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
          switch (draft.type) {
            case 'post':
              await this.dependencies.moderationService.submitPost(draft.data);
              break;
            case 'marker':
              await this.dependencies.markerService.create(draft.data);
              break;
            case 'route':
              await this.dependencies.routeService.save(draft.data);
              break;
            case 'event':
              await this.dependencies.eventsStore.createEvent(draft.data);
              break;
          }
          
          // –£—Å–ø–µ—à–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
          draft.syncStatus = 'synced';
          await this.dependencies.offlineContentQueue.update(draft);
          
          result.success++;
          
          // –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞ —É—Å–ø–µ—à–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
          await this.registerGamifiedAction(`sync_${draft.type}`, {});
          
        } catch (error) {
          draft.syncStatus = 'failed';
          draft.retryCount++;
          draft.lastError = error.message;
          draft.updatedAt = Date.now();
          
          await this.dependencies.offlineContentQueue.update(draft);
          
          result.failed++;
          result.errors.push({
            id: draft.id,
            error: error.message
          });
          
          // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
          await this.logActivity('sync_error', {
            draftId: draft.id,
            type: draft.type,
            error: error.message,
            retryCount: draft.retryCount
          });
        }
      }
      
      // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
      this.dependencies.notificationService.notify({
        type: 'sync_complete',
        title: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞',
        message: `–£—Å–ø–µ—à–Ω–æ: ${result.success}, –û—à–∏–±–æ–∫: ${result.failed}`,
        duration: 5000
      });
      
      return result;
      
    } finally {
      this.syncInProgress = false;
    }
  }
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
  private setupOfflineSync(): void {
    window.addEventListener('online', async () => {
      const drafts = await this.getOfflineDrafts(undefined, 'pending');
      if (drafts.length > 0) {
        // –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å pending —á–µ—Ä–Ω–æ–≤–∏–∫–∏
        await this.syncAllDrafts();
      }
    });
  }
}
üìà 6. –ê–ù–ê–õ–ò–¢–ò–ö–ê –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ô
typescript
enum MapAnalyticsEvent {
  // –û—Å–Ω–æ–≤–Ω—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
  MAP_LOAD = 'map_load',
  MAP_ZOOM = 'map_zoom',
  MAP_PAN = 'map_pan',
  MAP_CLICK = 'map_click',
  
  // –ú–∞—Ä–∫–µ—Ä—ã
  MARKER_CREATE = 'marker_create',
  MARKER_CLICK = 'marker_click',
  MARKER_EDIT = 'marker_edit',
  MARKER_DELETE = 'marker_delete',
  
  // –ú–∞—Ä—à—Ä—É—Ç—ã
  ROUTE_PLAN = 'route_plan',
  ROUTE_SAVE = 'route_save',
  ROUTE_SHARE = 'route_share',
  
  // –ü–æ–∏—Å–∫
  SEARCH_PERFORM = 'search_perform',
  SEARCH_RESULT_CLICK = 'search_result_click',
  
  // –û—Ñ–ª–∞–π–Ω
  OFFLINE_MODE_ENABLE = 'offline_mode_enable',
  OFFLINE_DOWNLOAD_START = 'offline_download_start',
  OFFLINE_DOWNLOAD_COMPLETE = 'offline_download_complete',
  
  // –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã
  CONTEXT_SWITCH = 'context_switch',
  
  // –°–æ–±—ã—Ç–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
  EVENT_VIEW = 'event_view',
  EVENT_CREATE = 'event_create',
  EVENT_HIGHLIGHT = 'event_highlight'
}

interface AnalyticsMetadata {
  userId?: string;
  sessionId?: string;
  context?: string;
  coordinates?: [number, number];
  zoomLevel?: number;
  duration?: number;
  error?: string;
}

class MapContextFacade {
  private analyticsSessionId: string;
  private lastInteractionTime: number = Date.now();
  
  private setupAnalytics(): void {
    this.analyticsSessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
    setInterval(() => {
      const idleTime = Date.now() - this.lastInteractionTime;
      if (idleTime > 5 * 60 * 1000) { // 5 –º–∏–Ω—É—Ç
        this.trackMapEvent(MapAnalyticsEvent.MAP_LOAD, {
          sessionDuration: idleTime,
          action: 'session_idle_timeout'
        });
      }
    }, 60 * 1000); // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
  }
  
  // –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ —Ç—Ä–µ–∫–∏–Ω–≥–∞
  trackMapEvent(
    event: MapAnalyticsEvent,
    metadata?: AnalyticsMetadata
  ): void {
    const user = this.dependencies.userService.getCurrentUser();
    
    const eventData = {
      event,
      timestamp: Date.now(),
      sessionId: this.analyticsSessionId,
      userId: user.id,
      userRole: user.role,
      context: this.activeContext,
      ...metadata
    };
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
    this.lastInteractionTime = Date.now();
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å
    this.dependencies.analyticsOrchestrator.track(event, eventData);
    
    // –¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É
    this.dependencies.analyticsOrchestrator.trackProductEvent(event, {
      ...eventData,
      // –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
      coordinates: metadata?.coordinates ? 
        this.anonymizeCoordinates(metadata.coordinates) : undefined
    });
  }
  
  // –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 2 –∑–Ω–∞–∫–æ–≤)
  private anonymizeCoordinates(coords: [number, number]): [number, number] {
    return [
      Math.round(coords[0] * 100) / 100,
      Math.round(coords[1] * 100) / 100
    ];
  }
  
  // –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç—Ä–µ–∫–∏–Ω–≥–∞ –º–µ—Ç–æ–¥–æ–≤
  private withAnalyticsTracking(
    methodName: string,
    fn: (...args: any[]) => any
  ) {
    return async (...args: any[]) => {
      const startTime = Date.now();
      
      try {
        this.trackMapEvent(`${methodName}_start` as any, {
          args: this.sanitizeForAnalytics(args)
        });
        
        const result = await fn(...args);
        
        const duration = Date.now() - startTime;
        this.trackMapEvent(`${methodName}_success` as any, {
          duration,
          resultType: typeof result
        });
        
        return result;
      } catch (error) {
        const duration = Date.now() - startTime;
        this.trackMapEvent(`${methodName}_error` as any, {
          duration,
          error: error.message
        });
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Å–µ—Ä–≤–∏—Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
        this.dependencies.analyticsOrchestrator.trackError(
          `map_${methodName}_error`,
          error,
          { args: this.sanitizeForAnalytics(args) }
        );
        
        throw error;
      }
    };
  }
  
  // –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (—É–¥–∞–ª–µ–Ω–∏–µ PII)
  private sanitizeForAnalytics(data: any): any {
    if (!data || typeof data !== 'object') return data;
    
    const sensitiveFields = ['password', 'token', 'email', 'phone', 'address'];
    const sanitized = { ...data };
    
    sensitiveFields.forEach(field => {
      if (sanitized[field]) {
        sanitized[field] = '[REDACTED]';
      }
    });
    
    return sanitized;
  }
}
üìç 7. –ö–ê–¢–ï–ì–û–†–ò–ò –ò –ö–ê–°–¢–û–ú–ù–´–ï –ú–ê–†–ö–ï–†–´
typescript
interface MarkerCategory {
  id: string;
  name: string;
  description: string;
  color: string;
  icon: string;
  iconType: 'droplet' | 'circle' | 'square' | 'pin';
  priority: number;
}

interface IconOptions {
  iconUrl: string;
  iconSize: [number, number];
  iconAnchor: [number, number];
  popupAnchor: [number, number];
  shadowUrl?: string;
  shadowSize?: [number, number];
  shadowAnchor?: [number, number];
  className?: string;
}

class MapContextFacade {
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –º–∞—Ä–∫–µ—Ä–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  getMarkerIcon(categoryId: string, options?: {
    size?: 'small' | 'medium' | 'large';
    isSelected?: boolean;
    hasPulse?: boolean;
  }): IconOptions {
    const category = this.dependencies.markerService.getCategory(categoryId);
    if (!category) {
      // –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∏–∫–æ–Ω–∫–∞
      return this.getDefaultIcon(options);
    }
    
    const size = options?.size || 'medium';
    const sizes = {
      small: [24, 36],
      medium: [32, 48],
      large: [40, 60]
    }[size];
    
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –º–∞—Ä–∫–µ—Ä–∞
    let iconType = category.iconType;
    if (categoryId === 'event') {
      iconType = 'circle'; // –°–æ–±—ã—Ç–∏—è - –∫—Ä—É–≥–ª—ã–µ
    } else if (categoryId.startsWith('post_')) {
      iconType = 'droplet'; // –ü–æ—Å—Ç—ã - –∫–∞–ø–ª–µ–≤–∏–¥–Ω—ã–µ
    }
    
    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ URL –∏–∫–æ–Ω–∫–∏
    const iconName = `${iconType}_${category.icon}`;
    const selectedSuffix = options?.isSelected ? '_selected' : '';
    const pulseSuffix = options?.hasPulse ? '_pulse' : '';
    
    return {
      iconUrl: `/markers/${iconName}${selectedSuffix}${pulseSuffix}.svg`,
      iconSize: sizes as [number, number],
      iconAnchor: [sizes[0] / 2, sizes[1]],
      popupAnchor: [0, -sizes[1]],
      className: `marker-${categoryId} ${options?.isSelected ? 'selected' : ''}`
    };
  }
  
  private getDefaultIcon(options?: any): IconOptions {
    return {
      iconUrl: '/markers/default_droplet.svg',
      iconSize: [32, 48],
      iconAnchor: [16, 48],
      popupAnchor: [0, -48]
    };
  }
  
  // –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–µ–π
  async createMarkerWithCategory(
    markerData: Omit<DraftMarker, 'category'>,
    autoDetectCategory?: boolean
  ): Promise<string> {
    let categoryId = markerData.category;
    
    // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    if (autoDetectCategory && !categoryId) {
      const detectedCategory = await this.detectMarkerCategory(markerData);
      categoryId = detectedCategory?.id || 'default';
    }
    
    const completeMarker: DraftMarker = {
      ...markerData,
      category: categoryId!,
      iconConfig: this.getMarkerIcon(categoryId!)
    };
    
    return this.createMarker(completeMarker);
  }
  
  // –î–µ—Ç–µ–∫—Ç–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
  private async detectMarkerCategory(markerData: any): Promise<MarkerCategory | null> {
    const categories = this.dependencies.markerService.getAllCategories();
    
    // –ü—Ä–æ—Å—Ç–µ–π—à–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é
    if (markerData.description) {
      const desc = markerData.description.toLowerCase();
      
      for (const category of categories) {
        const keywords = category.name.toLowerCase().split(' ');
        if (keywords.some(keyword => desc.includes(keyword))) {
          return category;
        }
      }
    }
    
    return null;
  }
}
üñ•Ô∏è 8. –î–í–£–•–û–ö–û–ù–ù–´–ô –†–ï–ñ–ò–ú –ò –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø
typescript
interface SplitScreenState {
  left: {
    context: MapContext | 'calendar' | 'planner' | null;
    instance: any; // Map instance –∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
    viewState?: {
      center: [number, number];
      zoom: number;
      bounds?: MapBounds;
    };
  };
  right: {
    context: MapContext | 'calendar' | 'planner' | null;
    instance: any;
    viewState?: {
      center: [number, number];
      zoom: number;
      bounds?: MapBounds;
    };
  };
  syncMode: 'none' | 'center' | 'bounds' | 'full';
  isActive: boolean;
}

class MapContextFacade {
  private splitScreenState: SplitScreenState = {
    left: { context: null, instance: null },
    right: { context: null, instance: null },
    syncMode: 'none',
    isActive: false
  };
  
  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–≤—É—Ö–æ–∫–æ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
  setSplitScreenMode(config: {
    leftContext: SplitScreenState['left']['context'];
    rightContext: SplitScreenState['right']['context'];
    syncMode?: SplitScreenState['syncMode'];
    initialView?: {
      center: [number, number];
      zoom: number;
    };
  }): void {
    this.splitScreenState = {
      left: {
        context: config.leftContext,
        instance: null,
        viewState: config.initialView ? {
          center: config.initialView.center,
          zoom: config.initialView.zoom
        } : undefined
      },
      right: {
        context: config.rightContext,
        instance: null,
        viewState: config.initialView ? {
          center: config.initialView.center,
          zoom: config.initialView.zoom
        } : undefined
      },
      syncMode: config.syncMode || 'none',
      isActive: true
    };
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
    this.initializeSplitScreenContexts();
    
    // –¢—Ä–µ–∫–∏–Ω–≥
    this.trackMapEvent(MapAnalyticsEvent.CONTEXT_SWITCH, {
      from: 'single',
      to: 'split',
      leftContext: config.leftContext,
      rightContext: config.rightContext,
      syncMode: config.syncMode
    });
  }
  
  private initializeSplitScreenContexts(): void {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–µ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    if (this.splitScreenState.left.context) {
      this.splitScreenState.left.instance = 
        this.createMapInstance(this.splitScreenState.left.context);
      
      if (this.splitScreenState.left.viewState) {
        this.splitScreenState.left.instance.setView(
          this.splitScreenState.left.viewState.center,
          this.splitScreenState.left.viewState.zoom
        );
      }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∞–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    if (this.splitScreenState.right.context) {
      this.splitScreenState.right.instance = 
        this.createMapInstance(this.splitScreenState.right.context);
      
      if (this.splitScreenState.right.viewState) {
        this.splitScreenState.right.instance.setView(
          this.splitScreenState.right.viewState.center,
          this.splitScreenState.right.viewState.zoom
        );
      }
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    this.setupSplitScreenSync();
  }
  
  private setupSplitScreenSync(): void {
    if (this.splitScreenState.syncMode === 'none' || 
        !this.splitScreenState.left.instance || 
        !this.splitScreenState.right.instance) {
      return;
    }
    
    const leftMap = this.splitScreenState.left.instance;
    const rightMap = this.splitScreenState.right.instance;
    
    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    leftMap.off('moveend');
    rightMap.off('moveend');
    
    switch (this.splitScreenState.syncMode) {
      case 'center':
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–µ–Ω—Ç—Ä–∞ –∏ –∑—É–º–∞
        leftMap.on('moveend', () => {
          const center = leftMap.getCenter();
          const zoom = leftMap.getZoom();
          rightMap.setView(center, zoom);
          this.updateSplitScreenViewState('right', { center, zoom });
        });
        break;
        
      case 'bounds':
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≥—Ä–∞–Ω–∏—Ü
        leftMap.on('moveend', () => {
          const bounds = leftMap.getBounds();
          rightMap.fitBounds(bounds);
          this.updateSplitScreenViewState('right', { bounds });
        });
        break;
        
      case 'full':
        // –ü–æ–ª–Ω–∞—è –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        const syncMaps = (source: any, target: any, side: 'left' | 'right') => {
          const center = source.getCenter();
          const zoom = source.getZoom();
          target.setView(center, zoom);
          this.updateSplitScreenViewState(side, { center, zoom });
        };
        
        leftMap.on('moveend', () => syncMaps(leftMap, rightMap, 'right'));
        rightMap.on('moveend', () => syncMaps(rightMap, leftMap, 'left'));
        break;
    }
  }
  
  private updateSplitScreenViewState(
    side: 'left' | 'right',
    viewState: Partial<SplitScreenState['left']['viewState']>
  ): void {
    if (side === 'left') {
      this.splitScreenState.left.viewState = {
        ...this.splitScreenState.left.viewState,
        ...viewState
      } as any;
    } else {
      this.splitScreenState.right.viewState = {
        ...this.splitScreenState.right.viewState,
        ...viewState
      } as any;
    }
  }
  
  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –æ–¥–∏–Ω–æ—á–Ω—ã–º –∏ –¥–≤—É—Ö–æ–∫–æ–Ω–Ω—ã–º —Ä–µ–∂–∏–º–æ–º
  toggleSplitScreen(enabled: boolean): void {
    if (enabled && !this.splitScreenState.isActive) {
      // –í–∫–ª—é—á–µ–Ω–∏–µ –¥–≤—É—Ö–æ–∫–æ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
      this.setSplitScreenMode({
        leftContext: 'map',
        rightContext: 'calendar',
        syncMode: 'center'
      });
    } else if (!enabled && this.splitScreenState.isActive) {
      // –í—ã–∫–ª—é—á–µ–Ω–∏–µ –¥–≤—É—Ö–æ–∫–æ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
      this.splitScreenState.isActive = false;
      
      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∫–Ω–∞
      const activeContext = this.activeContext;
      const activeInstance = this.splitScreenState.left.instance || 
                           this.splitScreenState.right.instance;
      
      // –û—á–∏—Å—Ç–∫–∞
      this.splitScreenState.left.instance?.destroy();
      this.splitScreenState.right.instance?.destroy();
      this.splitScreenState = {
        left: { context: null, instance: null },
        right: { context: null, instance: null },
        syncMode: 'none',
        isActive: false
      };
      
      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
      this.setActiveContext(activeContext);
    }
  }
}
üé® 9. UI –ò–ù–¢–ï–ì–†–ê–¶–ò–ò –ò –ö–û–ú–ü–û–ù–ï–ù–¢–´
typescript
interface MapActionButton {
  id: string;
  icon: React.ReactNode;
  label: string;
  description?: string;
  onClick: () => void | Promise<void>;
  isActive?: boolean;
  isDisabled?: boolean;
  badge?: number | string;
  tooltip?: string;
  variant?: 'primary' | 'secondary' | 'danger' | 'success';
  position?: 'top' | 'middle' | 'bottom';
}

interface GlassPanelConfig {
  style: React.CSSProperties;
  content: React.ReactNode;
  position: 'left' | 'right' | 'top' | 'bottom';
  width: number | string;
  height: number | string;
  isCollapsible: boolean;
  animationDuration: number;
}

class MapContextFacade {
  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ç–µ–∫–ª—è–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
  getGlassPanelConfig(context?: MapContext): GlassPanelConfig {
    const isDarkMode = this.dependencies.userService.getTheme() === 'dark';
    
    return {
      style: {
        backdropFilter: 'blur(16px) saturate(180%)',
        background: isDarkMode 
          ? 'rgba(30, 41, 59, 0.8)' 
          : 'rgba(255, 255, 255, 0.8)',
        border: `1px solid ${isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}`,
        borderRadius: '16px',
        boxShadow: '0 8px 32px rgba(0, 0, 0, 0.1)',
        padding: '12px 8px',
        display: 'flex',
        flexDirection: 'column',
        gap: '8px',
        zIndex: 1000
      },
      content: this.renderActionButtons(context),
      position: 'right',
      width: 'auto',
      height: 'auto',
      isCollapsible: true,
      animationDuration: 300
    };
  }
  
  // –†–µ–Ω–¥–µ—Ä –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  private renderActionButtons(context?: MapContext): React.ReactNode {
    const buttons = this.getActionButtonsConfig(context);
    
    return (
      <div className="map-action-buttons">
        {buttons.map(button => (
          <button
            key={button.id}
            className={`
              map-action-button 
              ${button.isActive ? 'active' : ''}
              ${button.isDisabled ? 'disabled' : ''}
              variant-${button.variant || 'secondary'}
            `}
            onClick={button.onClick}
            title={button.tooltip || button.label}
            disabled={button.isDisabled}
          >
            <div className="button-icon">
              {button.icon}
              {button.badge !== undefined && (
                <span className="button-badge">{button.badge}</span>
              )}
            </div>
            <span className="button-label">{button.label}</span>
          </button>
        ))}
      </div>
    );
  }
  
  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  getActionButtonsConfig(context?: MapContext): MapActionButton[] {
    const activeContext = context || this.activeContext;
    const user = this.dependencies.userService.getCurrentUser();
    const favorites = this.getFavorites();
    
    const baseButtons: MapActionButton[] = [
      {
        id: 'favorites',
        icon: <HeartIcon />,
        label: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ',
        badge: favorites.length,
        onClick: () => this.showFavoritesPanel(),
        tooltip: `–ò–∑–±—Ä–∞–Ω–Ω–æ–µ (${favorites.length})`,
        position: 'top'
      },
      {
        id: 'legend',
        icon: <LayersIcon />,
        label: '–õ–µ–≥–µ–Ω–¥–∞',
        onClick: () => this.showMapLegend(),
        position: 'top'
      },
      {
        id: 'settings',
        icon: <SettingsIcon />,
        label: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
        onClick: () => this.showMapSettings(),
        position: 'bottom'
      }
    ];
    
    switch (activeContext) {
      case 'map':
        return [
          ...baseButtons,
          {
            id: 'add_marker',
            icon: <PlusIcon />,
            label: '–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∫—É',
            onClick: () => this.startMarkerCreation(),
            variant: 'primary',
            isActive: this.isCreatingMarker,
            tooltip: '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –º–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç—É',
            position: 'middle'
          },
          {
            id: 'search',
            icon: <SearchIcon />,
            label: '–ü–æ–∏—Å–∫',
            onClick: () => this.showSearchPanel(),
            tooltip: '–ü–æ–∏—Å–∫ –º–µ—Å—Ç –∏ –∞–¥—Ä–µ—Å–æ–≤',
            position: 'middle'
          }
        ];
        
      case 'planner':
        return [
          ...baseButtons,
          {
            id: 'add_waypoint',
            icon: <FlagIcon />,
            label: '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É',
            onClick: () => this.addWaypointToRoute(),
            variant: 'primary',
            tooltip: '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É –º–∞—Ä—à—Ä—É—Ç–∞',
            position: 'middle'
          },
          {
            id: 'clear_route',
            icon: <TrashIcon />,
            label: '–û—á–∏—Å—Ç–∏—Ç—å',
            onClick: () => this.clearCurrentRoute(),
            variant: 'danger',
            tooltip: '–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç',
            position: 'middle'
          }
        ];
        
      case 'offline':
        return [
          ...baseButtons.filter(b => b.id !== 'add_marker'),
          {
            id: 'download_area',
            icon: <DownloadIcon />,
            label: '–°–∫–∞—á–∞—Ç—å –æ–±–ª–∞—Å—Ç—å',
            onClick: () => this.startAreaDownload(),
            isDisabled: !user.isPremium,
            tooltip: user.isPremium 
              ? '–°–∫–∞—á–∞—Ç—å –∫–∞—Ä—Ç—ã –¥–ª—è –æ—Ñ–ª–∞–π–Ω-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è' 
              : '–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–µ–º–∏—É–º-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
            variant: 'primary',
            position: 'middle'
          },
          {
            id: 'tracking',
            icon: <NavigationIcon />,
            label: '–¢—Ä–µ–∫–∏–Ω–≥',
            onClick: () => this.toggleGPSTracking(),
            isDisabled: !user.isPremium,
            tooltip: user.isPremium 
              ? '–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å GPS-—Ç—Ä–µ–∫–∞' 
              : '–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–µ–º–∏—É–º-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
            position: 'middle'
          }
        ];
        
      default:
        return baseButtons;
    }
  }
  
  // –ú–∏–Ω–∏-–ø–æ–ø–∞–ø—ã –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  getMiniPopupForItem(
    item: FavoriteItem | CalendarEvent | UnifiedMarker
  ): React.ReactNode {
    if ('type' in item && item.type === 'event') {
      return this.renderEventPopup(item as CalendarEvent);
    }
    
    if ('type' in item && item.type === 'post') {
      return this.renderPostPopup(item as any);
    }
    
    return this.renderDefaultPopup(item);
  }
  
  private renderPostPopup(post: any): React.ReactNode {
    return (
      <div className="glassmorphism-popup post-mini-popup">
        <div className="popup-header">
          <span className="post-category">{post.category}</span>
          <h4>{post.title}</h4>
        </div>
        <div className="popup-content">
          <p className="post-excerpt">{post.excerpt}</p>
          {post.photo && (
            <img 
              src={post.photo} 
              alt={post.title} 
              className="post-thumbnail"
            />
          )}
        </div>
        <div className="popup-actions">
          <button onClick={() => this.navigateToPost(post.id)}>
            –ß–∏—Ç–∞—Ç—å
          </button>
          <button onClick={() => this.addToFavorites(post)}>
            –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
          </button>
        </div>
      </div>
    );
  }
}
üîÑ 10. –ï–î–ò–ù–´–ô –ú–ï–•–ê–ù–ò–ó–ú –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò
typescript
interface SyncConfig {
  autoSync: boolean;
  syncInterval: number; // –≤ –º–∏–Ω—É—Ç–∞—Ö
  syncOnAppStart: boolean;
  syncOnNetworkRestore: boolean;
  maxRetries: number;
  retryDelay: number; // –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
}

interface SyncStatus {
  lastSync: number | null;
  nextSync: number | null;
  isSyncing: boolean;
  pendingItems: number;
  errors: Array<{
    id: string;
    type: string;
    error: string;
    timestamp: number;
    retryCount: number;
  }>;
  stats: {
    totalSynced: number;
    totalFailed: number;
    lastSuccessRate: number;
  };
}

class MapContextFacade {
  private syncConfig: SyncConfig = {
    autoSync: true,
    syncInterval: 15, // 15 –º–∏–Ω—É—Ç
    syncOnAppStart: true,
    syncOnNetworkRestore: true,
    maxRetries: 3,
    retryDelay: 5000 // 5 —Å–µ–∫—É–Ω–¥
  };
  
  private syncStatus: SyncStatus = {
    lastSync: null,
    nextSync: null,
    isSyncing: false,
    pendingItems: 0,
    errors: [],
    stats: {
      totalSynced: 0,
      totalFailed: 0,
      lastSuccessRate: 100
    }
  };
  
  private syncIntervalId: NodeJS.Timeout | null = null;
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
  private setupSync(): void {
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    if (this.syncConfig.syncOnAppStart) {
      setTimeout(() => this.autoSyncIfNeeded(), 10000); // –ß–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
    }
    
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
    if (this.syncConfig.autoSync) {
      this.syncIntervalId = setInterval(
        () => this.autoSyncIfNeeded(),
        this.syncConfig.syncInterval * 60 * 1000
      );
    }
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ç–∏
    if (this.syncConfig.syncOnNetworkRestore) {
      window.addEventListener('online', () => {
        this.dependencies.notificationService.notify({
          type: 'network_restored',
          title: '–°–µ—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞',
          message: '–ù–∞—á–∏–Ω–∞—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é...'
        });
        setTimeout(() => this.autoSyncIfNeeded(), 2000);
      });
    }
  }
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  private async autoSyncIfNeeded(): Promise<void> {
    if (this.syncStatus.isSyncing) return;
    
    const drafts = await this.getOfflineDrafts(undefined, 'pending');
    if (drafts.length === 0) return;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–≥–¥–∞ –±—ã–ª–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
    const now = Date.now();
    const lastSync = this.syncStatus.lastSync || 0;
    const timeSinceLastSync = now - lastSync;
    
    // –ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç
    if (timeSinceLastSync < 5 * 60 * 1000) return;
    
    // –ù–∞—á–∏–Ω–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
    await this.syncAllContent();
  }
  
  // –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
  async syncAllContent(): Promise<SyncResult> {
    if (this.syncStatus.isSyncing) {
      throw new Error('Sync already in progress');
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = this.dependencies.userService.getCurrentUser();
    if (!user.isPremium && !this.isOnline()) {
      throw new Error('Sync available only for premium users in offline mode');
    }
    
    this.syncStatus.isSyncing = true;
    this.syncStatus.pendingItems = await this.countPendingItems();
    
    try {
      // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      this.dependencies.notificationService.notify({
        type: 'sync_start',
        title: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è',
        message: `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é ${this.syncStatus.pendingItems} —ç–ª–µ–º–µ–Ω—Ç–æ–≤...`,
        duration: 3000
      });
      
      // –¢—Ä–µ–∫–∏–Ω–≥ –Ω–∞—á–∞–ª–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      this.trackMapEvent(MapAnalyticsEvent.OFFLINE_DOWNLOAD_START, {
        pendingItems: this.syncStatus.pendingItems
      });
      
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ —Ç–∏–ø–∞–º –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      const results = {
        posts: await this.syncContentType('post'),
        markers: await this.syncContentType('marker'),
        routes: await this.syncContentType('route'),
        events: await this.syncContentType('event')
      };
      
      // –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      const total = Object.values(results).reduce((sum, r) => sum + r.total, 0);
      const success = Object.values(results).reduce((sum, r) => sum + r.success, 0);
      const failed = Object.values(results).reduce((sum, r) => sum + r.failed, 0);
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      this.syncStatus.lastSync = Date.now();
      this.syncStatus.nextSync = Date.now() + this.syncConfig.syncInterval * 60 * 1000;
      this.syncStatus.stats.totalSynced += success;
      this.syncStatus.stats.totalFailed += failed;
      this.syncStatus.stats.lastSuccessRate = total > 0 ? (success / total) * 100 : 100;
      
      // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ—à–∏–±–æ–∫
      this.cleanupOldErrors();
      
      // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
      const message = failed === 0
        ? `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ (${success} —ç–ª–µ–º–µ–Ω—Ç–æ–≤)`
        : `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –æ—à–∏–±–∫–∞–º–∏: ${success} —É—Å–ø–µ—à–Ω–æ, ${failed} —Å –æ—à–∏–±–∫–∞–º–∏`;
      
      this.dependencies.notificationService.notify({
        type: failed === 0 ? 'sync_success' : 'sync_partial',
        title: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞',
        message,
        duration: 5000
      });
      
      // –¢—Ä–µ–∫–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
      this.trackMapEvent(MapAnalyticsEvent.OFFLINE_DOWNLOAD_COMPLETE, {
        success,
        failed,
        total,
        successRate: this.syncStatus.stats.lastSuccessRate
      });
      
      return { total, success, failed, errors: this.collectAllErrors(results) };
      
    } finally {
      this.syncStatus.isSyncing = false;
      this.syncStatus.pendingItems = 0;
    }
  }
  
  private async syncContentType(type: OfflineDraft['type']): Promise<SyncResult> {
    const drafts = await this.getOfflineDrafts(type, 'pending');
    const result: SyncResult = {
      total: drafts.length,
      success: 0,
      failed: 0,
      errors: []
    };
    
    for (const draft of drafts) {
      try {
        // –ü—Ä–æ–ø—É—Å–∫ –µ—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
        if (draft.retryCount >= this.syncConfig.maxRetries) {
          result.failed++;
          result.errors.push({
            id: draft.id,
            error: `Max retries exceeded (${draft.retryCount})`
          });
          continue;
        }
        
        // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
        if (draft.retryCount > 0) {
          await this.delay(this.syncConfig.retryDelay * draft.retryCount);
        }
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        switch (type) {
          case 'post':
            await this.dependencies.moderationService.submitPost(draft.data);
            break;
          case 'marker':
            await this.dependencies.markerService.create(draft.data);
            break;
          case 'route':
            await this.dependencies.routeService.save(draft.data);
            break;
          case 'event':
            await this.dependencies.eventsStore.createEvent(draft.data);
            break;
        }
        
        // –£—Å–ø–µ—à–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è - —É–¥–∞–ª—è–µ–º —á–µ—Ä–Ω–æ–≤–∏–∫
        await this.dependencies.offlineContentQueue.remove(draft.id);
        result.success++;
        
        // –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è
        await this.registerGamifiedAction(`sync_${type}`, {
          draftId: draft.id
        });
        
      } catch (error) {
        result.failed++;
        result.errors.push({
          id: draft.id,
          error: error.message
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ —Å –æ—à–∏–±–∫–æ–π
        draft.syncStatus = 'failed';
        draft.retryCount++;
        draft.lastError = error.message;
        draft.updatedAt = Date.now();
        
        await this.dependencies.offlineContentQueue.update(draft);
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
        await this.logActivity('sync_error', {
          draftId: draft.id,
          type,
          error: error.message,
          retryCount: draft.retryCount
        });
      }
    }
    
    return result;
  }
  
  private async countPendingItems(): Promise<number> {
    const drafts = await this.getOfflineDrafts(undefined, 'pending');
    return drafts.length;
  }
  
  private collectAllErrors(results: Record<string, SyncResult>): Array<{ id: string; error: string }> {
    const allErrors: Array<{ id: string; error: string }> = [];
    Object.values(results).forEach(result => {
      allErrors.push(...result.errors);
    });
    return allErrors;
  }
  
  private cleanupOldErrors(): void {
    const now = Date.now();
    const cutoff = now - 7 * 24 * 60 * 60 * 1000; // 7 –¥–Ω–µ–π
    
    this.syncStatus.errors = this.syncStatus.errors.filter(
      error => error.timestamp > cutoff
    );
  }
  
  private delay(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
  
  // –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
  getSyncStatus(): SyncStatus {
    return { ...this.syncStatus };
  }
  
  updateSyncConfig(config: Partial<SyncConfig>): void {
    this.syncConfig = { ...this.syncConfig, ...config };
    
    // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è
    if (this.syncIntervalId) {
      clearInterval(this.syncIntervalId);
    }
    
    if (this.syncConfig.autoSync) {
      this.syncIntervalId = setInterval(
        () => this.autoSyncIfNeeded(),
        this.syncConfig.syncInterval * 60 * 1000
      );
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
    localStorage.setItem('mapSyncConfig', JSON.stringify(this.syncConfig));
  }
}
üìã –ò–¢–û–ì–û–í–´–ô –ß–ï–ö-–õ–ò–°–¢ –†–ï–ê–õ–ò–ó–ê–¶–ò–ò
‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ‚Äî –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã

‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–µ–π ‚Äî XP, –ª–∏–º–∏—Ç—ã, –∑–∞—â–∏—Ç–∞ –æ—Ç –Ω–∞–∫—Ä—É—Ç–æ–∫

‚úÖ –†–∞–±–æ—Ç–∞ —Å –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º ‚Äî –º–∞—Ä–∫–µ—Ä—ã —Å–æ–±—ã—Ç–∏–π, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è, –∫—ç—à

‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–ª—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π

‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ—Ñ–ª–∞–π–Ω ‚Äî –≤—Å–µ —Ç–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –æ—á–µ—Ä–µ–¥—å, —Ä–µ—Ç—Ä–∞–∏

‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π ‚Äî —Ç—Ä–µ–∫–∏–Ω–≥, —Å–µ—Å—Å–∏–∏, –æ—à–∏–±–∫–∏

‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ ‚Äî –∫–∞–ø–ª–µ–≤–∏–¥–Ω—ã–µ, –∫—Ä—É–≥–ª—ã–µ, –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è

‚úÖ –î–≤—É—Ö–æ–∫–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º

‚úÖ UI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Äî —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–µ –ø–∞–Ω–µ–ª–∏, –∫–Ω–æ–ø–∫–∏, –ø–æ–ø–∞–ø—ã

‚úÖ –ï–¥–∏–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, —Å—Ç–∞—Ç—É—Å, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ