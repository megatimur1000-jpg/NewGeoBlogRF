## План рефакторинга фасада карт (только Яндекс)

### Цели
- Используем только провайдера Яндекс во всём приложении.
- Карту всегда инициализируем по центру Москвы, без «за Каспием».
- Клик по карте добавляет метку; метки и маршруты рендерятся стабильно.
- Меню Избранное синхронизировано: переносит метки/маршруты в Планировщик и обратно.
- Удаляем дубли и наследие: `pointManager`, `useRouteBuilder`, прямой `LazyYandexMap`.
- Нет ошибки `useNavigate()` в попапах; попапы не зависят от роутера.
- Нет внешних плейсхолдеров, не ловим `ERR_NAME_NOT_RESOLVED`.
- Простой, явный, тестируемый кодовый путь.

### Ограничения
- Внутри приложения — формат координат [lat, lng].
- Yandex API ожидает [lng, lat]. Конвертируем только на границах с API.
- Все побочные эффекты карты (init, clicks, markers, routes, clear) — внутри фасада.

### Архитектура
- `mapFacade.ts` предоставляет: `initializeMap`, `setCenter`, `addMarker`, `drawRoute`, `clear`, `onClick`.
- `YandexAdapter` реализует с чёткими конверсиями [lat, lng] <-> [lng, lat].
- React‑страницы (например, `Planner.tsx`) передают состояние (markers/routes) во фасад и не трогают Yandex API напрямую.

### Очистка (удаляем наследие)
- Убрать импорты/использование: `pointManager`, `useRouteBuilder`, прямой `LazyYandexMap`.
- Попапы с `useNavigate` заменить на заглушку или балуны Яндекса без роутера.
- Удалить переключатели провайдеров; жёстко `yandex` в `Planner.tsx`.

### Модели данных
- MapMarker: `{ id, lat, lon, title?, type? }` (в приложении — [lat, lng]).
- Route: `{ id?, points: [ [lat, lng], ... ] }`.

### Поток событий (Planner)
1) Монтирование → `mapFacade.initializeMap(container, { provider: 'yandex', center: Moscow, zoom, markers, routes })`.
2) Фасад подписывается на `ymaps` `click` и отдаёт в `onClick` координаты [lat, lng].
3) Страница обновляет состояние; инкрементально вызывает `mapFacade.addMarker` / `drawRoute`.
4) Кнопка Очистить: `mapFacade.clear()` и сброс локального состояния.

### Маршрутизация/роутинг (service)
- При CORS/HTTP ошибке возвращаем fallback‑полилинию и логируем предупреждение (UX не блокируем).

### Интеграция с UI
- `FacadeMap` (мемо):
  - Инициализирует фасад один раз.
  - Подписывает клики через `mapFacade.onClick`.
  - Добавляет метки/маршруты без переинициализации.
- `FavoritesPanel`:
  - Виден текущий выбор; переносит в Планировщик метки/маршруты.
  - Может построить маршрут из выбранных точек через `mapFacade.drawRoute`.
- Действия:
  - Очистить карту: чистим фасад и состояние.
  - Сохранить маршрут: сохраняем текущие точки (порядок важен), предлагаем культурное название (модалка), пишем в избранное.

### Сквозной цикл (ваш запрос)
1) Приём меток из `map.tsx` → в `Planner.tsx` через фасад/хранилище.
2) Верное отображение меток в `Planner.tsx`, построение маршрута, модалка названия.
3) Сохранение маршрута в Избранное; маршрут виден в панели Избранного и в ЛК.
4) Личный кабинет: фильтры для типов контента (блог/пост/событие) к которым привязаны метки/маршруты.
5) Переход в создание блогов/постов/событий — подтягиваем метки по выбранным фильтрам.
6) Проверяем рендер контента с маркерами/маршрутами и полную визуализацию.
7) Используем фасад в визуализациях контента, чтобы единообразно рисовать метки/маршруты.

Важно: планировщик — Яндекс‑карта. В остальных компонентах тоже используем фасад (и Яндекс) для единообразия. При необходимости другой провайдер можно добавить позже за фасадом, но сейчас придерживаемся Yandex‑only.

### Ошибки и логирование
- Глушим шумные ошибки расширений браузера про "message channel closed".
- Логируем ключевые шаги: init, setCenter, click, addMarker, drawRoute, clear.
- Внешние плейсхолдеры заменяем на локальные ассеты или data URI.

### Чек‑лист проверки
1) Инициализация
   - Логи инициализации; центр = Москва; нет Каспия; zoom ~10.
2) Клики
   - Клик добавляет метку; координаты в логах совпадают с визуалом.
3) Избранное
   - Чекбоксы работают; перенос в планировщик добавляет метки на карту.
4) Маршруты
   - 2+ меток → маршрут строится; при ошибке — fallback‑полилиния.
5) Очистка
   - Полная очистка карты и состояния; лог `clear()`.
6) Сохранение
   - Модалка названия; маршрут сохраняется; появляется в Избранном и ЛК.
7) Контент
   - В ЛК фильтруем привязанные маркеры/маршруты; в формах создания контента подтягиваем выбранное; отображаем на карте через фасад.
8) Активы
   - Нет запросов к внешним плейсхолдерам; отсутствует `ERR_NAME_NOT_RESOLVED`.

### Пошаговый план работ
1. Аудит проводки (где и как используется `mapFacade`, убрать дубли входов).
2. Удалить наследие и переключатели провайдеров; зафиксировать Yandex‑only.
3. В `YandexAdapter` проверить все вызовы и конверсии [lng, lat]; добавить логи.
4. Инициализация в `Planner.tsx` с Москвой и `onClick` через фасад.
5. Инкрементально добавлять метки/маршруты без реинициализации; проверить счётчики.
6. FavoritesPanel: выравнять данные под `MapMarker`; перенос/построение маршрута.
7. Кнопки: Очистить карту / Сохранить маршрут (модалка названия + сохранение).
8. Приём меток из `map.tsx` в планировщик через фасад/хранилище.
9. Синхронизация с ЛК: фильтры типов контента, отображение сохранённого.
10. Интеграция в формы создания контента: подтягивание меток/маршрутов.
11. Визуализация контента на карте через фасад (единый провайдер).
12. Замена внешних плейсхолдеров; финальный проход логики и чек‑лист.

### Примечания
- Любой «Каспий» — проверяем точки конверсии координат к Yandex API.
- Не реинициализируем карту по каждому изменению состояния — иначе теряем подписки и получаем мигание.


