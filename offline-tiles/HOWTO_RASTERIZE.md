# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ø–µ—Ä–µ–Ω–∞—Ä–µ–∑–∫–∞ –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö —Ç–∞–π–ª–æ–≤ (PBF) ‚Üí —Ä–∞—Å—Ç—Ä–æ–≤—ã–µ (PNG)

## –ü—Ä–æ–±–ª–µ–º–∞
–í–∞—à–∏ MBTiles —Ñ–∞–π–ª—ã —Å–æ–¥–µ—Ä–∂–∞—Ç **–≤–µ–∫—Ç–æ—Ä–Ω—ã–µ —Ç–∞–π–ª—ã** (—Ñ–æ—Ä–º–∞—Ç PBF/MVT), —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ OpenMapTiles –∏–ª–∏ –ø–æ–¥–æ–±–Ω—ã–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º.
–î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Leaflet –Ω—É–∂–Ω—ã **—Ä–∞—Å—Ç—Ä–æ–≤—ã–µ** —Ç–∞–π–ª—ã (PNG).

## üìã –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç

–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç –±—ã—Å—Ç—Ä—ã–π —á–µ–∫–ª–∏—Å—Ç. –û–Ω –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–∞—Ç–∞.

- [ ] 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞: –≤–µ—Ä—Å–∏–∏, –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ, —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ MBTiles
- [ ] 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: —Ñ–æ—Ä–º–∞—Ç, metadata, bounds/zoom
- [ ] 3. –í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞: tileserver‚Äëgl (–æ—Å–Ω–æ–≤–Ω–æ–π) / Mapnik/MapTiler (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π)
- [ ] 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ tileserver‚Äëgl: –∑–∞–ø—É—Å—Ç–∏—Ç—å, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∏–ª—å (/styles.json)
- [ ] 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–∞–π–ª–æ–≤: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- [ ] 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, —Ñ–æ—Ä–º–∞—Ç, —Å–ª—É—á–∞–π–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- [ ] 7. –£–ø–∞–∫–æ–≤–∫–∞: —Å–æ–∑–¥–∞—Ç—å MBTiles (png) –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å metadata
- [ ] 8. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: –∑–∞–º–µ–Ω–∏—Ç—å MBTiles –≤ –ø—Ä–æ–µ–∫—Ç–µ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- [ ] 9. –û—Ç–∫–∞—Ç: –∏–º–µ—Ç—å –≥–æ—Ç–æ–≤—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –∏ —à–∞–≥–∏ –æ—Ç–∫–∞—Ç–∞

### üìù –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π
- [ ] –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `tileserver` –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω):
  - `docker stop tileserver && docker rm tileserver`
  - –∏–ª–∏ `docker-compose -f docker-compose.tiles.yml down`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ MBTiles (–æ–∂–∏–¥–∞–µ–º `pbf`/`mvt` –¥–ª—è –≤–µ–∫—Ç–æ—Ä–∞):
  - `sqlite3 vla.mbtiles "SELECT value FROM metadata WHERE name='format';"`
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `generate_tiles.py` –ø–∏—à–µ—Ç –ª–æ–≥ –≤ `generate_tiles.log` (–≤—Å—Ç—Ä–æ–µ–Ω–æ –≤ —Å–∫—Ä–∏–ø—Ç).
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `tileserver` —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –æ—Ç–≤–µ—á–∞–µ—Ç:
  - `curl -f http://localhost:8080/styles.json` (–∫–æ–¥ 0 ‚Üí OK)
  - –∏–ª–∏ `docker ps --filter name=tileserver --format "{{.Names}} {{.Status}}"`
- [ ] –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏ –ø–∞–º—è—Ç–∏: `tileserver-gl` –∏ –º–∞—Å—Å–æ–≤–∞—è –≤—ã–≥—Ä—É–∑–∫–∞ –º–æ–≥—É—Ç –ø–æ—Ç—Ä–µ–±–ª—è—Ç—å –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—É—é RAM (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ 2‚Äì4+ GB –¥–ª—è —Ç—è–∂—ë–ª—ã—Ö —Å—Ç–∏–ª–µ–π). –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ `docker stats tileserver` –∏–ª–∏ `htop`.
- [ ] (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞: `df -h /path/to/output` –∏–ª–∏ PowerShell `Get-PSDrive -PSProvider FileSystem`.
- [ ] (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ü—Ä–æ–≥—Ä–µ—Å—Å‚Äë–±–∞—Ä: –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –≤–∫–ª—é—á–∏—Ç–µ `tqdm` (`pip3 install tqdm`) ‚Äî —Å–∫—Ä–∏–ø—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç—Ç–æ.

---

## 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
- –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π:
  ```bash
  docker --version; node -v; python3 -V; pip3 -V; sqlite3 --version
  ```
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –∏ RAM:
  - Linux/macOS: `df -h /path/to/output`
  - Windows (PowerShell): `Get-PSDrive -PSProvider FileSystem`
- –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ MBTiles:
  ```bash
  cp offline-tiles/vla.mbtiles offline-tiles/vla.mbtiles.bak
  # –∏–ª–∏ PowerShell:
  Copy-Item offline-tiles\vla.mbtiles offline-tiles\vla.mbtiles.bak
  ```
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –æ—Å—Ç–∞–≤—å—Ç–µ +20% —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö PNG.

## 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ metadata –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
  ```bash
  sqlite3 vla.mbtiles "SELECT name,value FROM metadata;"
  sqlite3 vla.mbtiles "SELECT zoom_level, COUNT(*) FROM tiles GROUP BY zoom_level;"
  ```
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–∏–ø ‚Äî –≤–µ–∫—Ç–æ—Ä (pbf/mvt). –ï—Å–ª–∏ `format` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —É–∫–∞–∑–∞–Ω `pbf`, –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ.
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `bounds`, `minzoom`/`maxzoom` –∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –æ–±–ª–∞—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –≤ —Å–∫—Ä–∏–ø—Ç–µ.

## 3. –í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
- –û—Å–Ω–æ–≤–Ω–æ–π: `tileserver-gl` + –º–∞—Å—Å–æ–≤–∞—è –≤—ã–≥—Ä—É–∑–∫–∞ PNG (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —ç—Ç–æ–º HOWTO).
- –†–µ–∑–µ—Ä–≤–Ω—ã–π: Mapnik/TileLive/MapTiler ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—Å–ª–∏ —Å—Ç–∏–ª—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è tileserver-gl.
- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–±–æ—Ä–∞: —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å—Ç–∏–ª—è, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

## 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ tileserver-gl
- –ó–∞–ø—É—Å–∫ (–ø—Ä–∏–º–µ—Ä –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ) –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–∏–ª–µ–π:
  ```bash
  curl http://localhost:8080/styles.json
  ```
- –ü–æ–¥—Å—Ç–∞–≤—å—Ç–µ —Ç–æ—á–Ω–æ–µ –∏–º—è —Å—Ç–∏–ª—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `STYLE` —É —Å–∫—Ä–∏–ø—Ç–∞.
- –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å `Cache-Control`/gzip/headers –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞.

## 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–∞–π–ª–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É—Å—Ç–æ–π—á–∏–≤—ã–π —Å–∫—Ä–∏–ø—Ç —Å retries/timeout –∏ –ø—Ä–æ–ø—É—Å–∫–æ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤ ‚Äî –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–æ–∑–æ–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–æ—Ü–µ—Å—Å. –°–∫—Ä–∏–ø—Ç —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `generate_tiles.log`, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ (`CHECK_DISK_SPACE`) –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å‚Äë–±–∞—Ä (`tqdm`).
- –ó–∞–ø—É—Å–∫ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –≤ —Ñ–æ–Ω–µ:
  ```bash
  python3 generate_tiles.py 2>&1 | tee generate_tiles.log
  # –∏–ª–∏ (PowerShell)
  python generate_tiles.py *>&1 | Tee-Object -FilePath generate_tiles.log
  ```
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å‚Äë–±–∞—Ä): `pip3 install requests tqdm`.
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: —Å–ª–µ–¥–∏—Ç–µ –∑–∞ `generate_tiles.log` –∏ –∑–∞ –≤—ã–≤–æ–¥–æ–º —Å–∫—Ä–∏–ø—Ç–∞ (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ OK/MISSING/ERR).
- –ï—Å–ª–∏ –ø—Ä–µ—Ä–≤–∞–Ω–æ ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–æ—Ç –∂–µ —Å–∫—Ä–∏–ø—Ç (–æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∏—Ç, –ø—Ä–æ–ø—É—Å–∫–∞—è —É–∂–µ —Å–∫–∞—á–∞–Ω–Ω—ã–µ).

## 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ metadata MBTiles –∏ —Ñ–æ—Ä–º–∞—Ç–∞:
  ```bash
  sqlite3 vla-raster.mbtiles "SELECT name,value FROM metadata;"
  ```
  –û–∂–∏–¥–∞–µ–º: `format = png`.
- –ü–æ–¥—Å—á—ë—Ç —Ç–∞–π–ª–æ–≤ –ø–æ zoom:
  ```bash
  sqlite3 vla-raster.mbtiles "SELECT zoom_level, COUNT(*) FROM tiles GROUP BY zoom_level ORDER BY zoom_level;"
  ```
- –°–ª—É—á–∞–π–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞ —Ç–∞–π–ª–æ–≤ (–ø—Ä–æ–≤–µ—Ä–∫–∞ HTTP –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ):
  ```bash
  curl -f http://localhost:8080/styles/<STYLE>/12/2048/1365.png -o /dev/null
  python3 -c "from PIL import Image; Image.open('path/to/sample.png').verify()"
  ```

## 7. –£–ø–∞–∫–æ–≤–∫–∞ –≤ MBTiles
- –°–æ–±—Ä–∞—Ç—å MBTiles (mb-util):
  ```bash
  pip3 install mbutil
  mb-util /path/to/output/vla-png /path/to/output/vla-raster.mbtiles --image_format=png --scheme=xyz
  ```
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å/–∑–∞–ø–∏—Å–∞—Ç—å metadata (`format`, `bounds`, `minzoom`, `maxzoom`, `center`).

## 8. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- –°–¥–µ–ª–∞–π—Ç–µ –±–µ–∫–∞–ø —Ç–µ–∫—É—â–µ–≥–æ mbtiles –∏ –∑–∞–º–µ–Ω—É:
  ```bash
  cp offline-tiles/vla.mbtiles offline-tiles/vla.mbtiles.pre-raster
  cp vla-raster.mbtiles offline-tiles/vla.mbtiles
  ```
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–µ–∫–µ–Ω–¥ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
  ```bash
  SKIP_DB=true node backend/server.js
  curl http://localhost:3002/api/tiles/vla/metadata | jq .format
  # –æ–∂–∏–¥–∞–µ–º: "png"
  ```
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∏–∑—É–∞–ª—å–Ω–æ –Ω–∞ `http://localhost:3002/test-tiles.html`.

# Post‚Äërun: –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ tileserver (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–ï—Å–ª–∏ –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—ã –Ω–µ —Ö–æ—Ç–∏—Ç–µ –¥–µ—Ä–∂–∞—Ç—å `tileserver` –∑–∞–ø—É—â–µ–Ω–Ω—ã–º ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
```bash
docker stop tileserver && docker rm tileserver
# –∏–ª–∏ (docker‚Äëcompose)
docker-compose -f docker-compose.tiles.yml down
```

## 9. –û—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É MBTiles:
  ```bash
  mv offline-tiles/vla.mbtiles.pre-raster offline-tiles/vla.mbtiles
  # –∏–ª–∏ PowerShell:
  Move-Item offline-tiles\vla.mbtiles.pre-raster offline-tiles\vla.mbtiles
  ```
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å.
- –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤: `generate.log`, —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏ –∏ `tileserver` stdout/stderr.

---

## üß™ –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç
- –°–∫–∞—á–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π MBTiles –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–∏–∂–µ –≤ —Ñ–∞–π–ª–µ).
- –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å MBTiles –≤ `offline-tiles` –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –±—ç–∫–µ–Ω–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.

## –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (systemd / PowerShell / CI)
–ù–∏–∂–µ ‚Äî –≥–æ—Ç–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –Ω–∞ Windows –∏ –ø—Ä–æ—Å—Ç–æ–≥–æ CI‚Äësmoke —Ç–µ—Å—Ç–∞.

### Systemd unit ‚Äî —Ñ–æ–Ω–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (Linux)
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `/etc/systemd/system/tiles-generate.service`:

```ini
[Unit]
Description=Generate raster tiles (PBF‚ÜíPNG)
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/srv/tiles
ExecStart=/usr/bin/python3 /srv/tiles/generate_tiles.py
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

–ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```bash
sudo systemctl daemon-reload
sudo systemctl enable --now tiles-generate.service
sudo journalctl -u tiles-generate.service -f
```

–°–æ–≤–µ—Ç: —É–∫–∞–∂–∏—Ç–µ `User=` —Å —É—á—ë—Ç–æ–º –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ `OUTPUT_DIR` –∏ MBTiles.

### PowerShell‚Äë—Å–∫—Ä–∏–ø—Ç‚Äë–æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è Windows
–§–∞–π–ª `generate-tiles.ps1` ‚Äî –∑–∞–ø—É—Å–∫–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é, –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏ –∫–æ–ø–∏—Ä—É–µ—Ç MBTiles –≤ `offline-tiles`:

```powershell
param(
  [string] $OutputMb = "vla-raster.mbtiles",
  [string] $ProjectOffline = "D:\newgeoblogrf\offline-tiles"
)
# –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–ª–æ–≥–∏—Ä—É–µ—Ç—Å—è)
python .\generate_tiles.py 2>&1 | Tee-Object -FilePath generate.log

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
if (-not (Test-Path $OutputMb)) { Write-Error "MBTiles not found: $OutputMb"; exit 1 }

# –ü—Ä–æ–≤–µ—Ä–∫–∞ metadata.format (–µ—Å–ª–∏ sqlite3 –≤ PATH)
$sqlite = Get-Command sqlite3 -ErrorAction SilentlyContinue
if ($sqlite) {
  $fmt = & sqlite3 $OutputMb "SELECT value FROM metadata WHERE name='format';"
  if ($fmt -ne 'png') { Write-Error "Bad format: $fmt"; exit 2 }
} else {
  # fallback: Python –ø—Ä–æ–≤–µ—Ä–∫–∞
  python - <<'PY'
import sqlite3
db=sqlite3.connect('" + $OutputMb + "')
cur=db.execute("SELECT value FROM metadata WHERE name='format'")
row=cur.fetchone()
if not row or row[0] != 'png':
    raise SystemExit('format-check-failed')
print('format=png')
PY
}

# –ö–æ–ø–∏—Ä—É–µ–º –≤ –ø—Ä–æ–µ–∫—Ç —Å –±—ç–∫–∞–ø–æ–º
$dest = Join-Path $ProjectOffline 'vla.mbtiles'
if (Test-Path $dest) { Copy-Item $dest ($dest + '.pre-raster') -Force }
Move-Item -Path $OutputMb -Destination $dest -Force
Write-Output "Deployed: $dest"
```

–ó–∞–ø—É—Å–∫ (PowerShell):
```powershell
.\generate-tiles.ps1 -OutputMb 'vla-raster.mbtiles' -ProjectOffline 'D:\newgeoblogrf\offline-tiles'
```

### CI smoke‚Äëtest ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ metadata.format == 'png'
–°–∫—Ä–∏–ø—Ç `check-mbtiles-format.sh`:

```bash
#!/usr/bin/env bash
set -euo pipefail
MB=$1
fmt=$(sqlite3 "$MB" "SELECT value FROM metadata WHERE name='format';")
if [ "$fmt" != "png" ]; then
  echo "Unexpected format: $fmt" >&2
  exit 1
fi
echo "OK: format=png"
```

–ü—Ä–∏–º–µ—Ä GitHub Actions job (`.github/workflows/check-mbtiles.yml`):

```yaml
name: MBTiles smoke
on: [push, pull_request]
jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run format check
        run: |
          chmod +x ./scripts/check-mbtiles-format.sh
          ./scripts/check-mbtiles-format.sh offline-tiles/vla.mbtiles
```

---

## –†–µ—à–µ–Ω–∏–µ: tileserver-gl –Ω–∞ Ubuntu


### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ tileserver-gl

```bash
# –ß–µ—Ä–µ–∑ Docker (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
docker pull maptiler/tileserver-gl

# –ü—Ä–∏–º–µ—Ä –∑–∞–ø—É—Å–∫–∞ (Linux / macOS)
docker run --rm -it \
  -v /path/to/your/tiles:/data \
  -p 8080:8080 \
  maptiler/tileserver-gl \
  --file /data/vla.mbtiles

# –ü—Ä–∏–º–µ—Ä –∑–∞–ø—É—Å–∫–∞ –Ω–∞ Windows (Docker Desktop / PowerShell).
# –ú–æ–∂–Ω–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—É—Ç—å –≤–∏–¥–∞ `d:/...` –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WSL –ø—É—Ç—å `/mnt/d/...`
docker run --rm -it \
  -v d:/newgeoblogrf/offline-tiles:/data \
  -p 8080:8080 \
  maptiler/tileserver-gl \
  --file /data/vla.mbtiles

# –ò–ª–∏ (WSL2):
# docker run --rm -it -v /mnt/d/newgeoblogrf/offline-tiles:/data -p 8080:8080 maptiler/tileserver-gl --file /data/vla.mbtiles

# –ö–æ—Ä–æ—Ç–∫–∏–π docker-compose (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
cat > docker-compose.tiles.yml <<'YAML'
version: "3.7"
services:
  tileserver:
    image: maptiler/tileserver-gl
    volumes:
      - ./offline-tiles:/data:ro
    ports:
      - "8080:8080"
    command: ["--file", "/data/vla.mbtiles"]
YAML

# –ò–ª–∏ —á–µ—Ä–µ–∑ npm (–µ—Å–ª–∏ –Ω–µ—Ç Docker)
npm install -g tileserver-gl
```

### 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PNG —Ç–∞–π–ª–æ–≤ –∏–∑ PBF

#### –í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ Docker + tileserver-gl (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –ó–∞–ø—É—Å–∫ tileserver-gl —Å –≤–∞—à–∏–º MBTiles
docker run --rm -it \
  -v /path/to/your/tiles:/data \
  -p 8080:8080 \
  maptiler/tileserver-gl \
  --file /data/vla.mbtiles

# –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8080 ‚Äî —Ç–∞–º –±—É–¥–µ—Ç –ø—Ä–µ–≤—å—é –∫–∞—Ä—Ç—ã
# tileserver-gl –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–Ω–¥–µ—Ä–∏—Ç PNG –∏–∑ PBF
# URL —Ç–∞–π–ª–æ–≤ (–ø—Ä–∏–º–µ—Ä): http://localhost:8080/styles/basic-preview/{z}/{x}/{y}.png
#
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏ —Ç–æ—á–Ω–æ–µ –∏–º—è —Å—Ç–∏–ª—è:
#   curl http://localhost:8080/styles.json
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ –∏–º—è —Å—Ç–∏–ª—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `STYLE` –≤ —Å–∫—Ä–∏–ø—Ç–µ.
```

#### –í–∞—Ä–∏–∞–Ω—Ç B: –ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è PNG —á–µ—Ä–µ–∑ tileserver-gl + —Å–∫—Ä–∏–ø—Ç (–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)

–≠—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ 10-20 —Ä–∞–∑.

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ tileserver-gl (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω)
docker run -d --name tileserver \
  -v /path/to/tiles:/data \
  -p 8080:8080 \
  maptiler/tileserver-gl \
  --file /data/vla.mbtiles

# 2. –°–∫–∞—á–∞–π—Ç–µ –≤—Å–µ —Ç–∞–π–ª—ã –≤ PNG (–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–π —Å–∫—Ä–∏–ø—Ç ‚Äî —É—Å—Ç–æ–π—á–∏–≤—ã–π, —Å retries –∏ —Ç–∞–π–º–∞—É—Ç–æ–º)
# –¢—Ä–µ–±—É–µ—Ç—Å—è: pip3 install requests
python3 << 'EOF'
import os
import math
import time
import sys
import shutil
import logging
import requests
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry
from concurrent.futures import ThreadPoolExecutor, as_completed
from tqdm import tqdm

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
TILESERVER = "http://localhost:8080"
STYLE = "basic-preview"  # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ—á–Ω–æ–µ –∏–º—è —á–µ—Ä–µ–∑ /styles.json
OUTPUT_DIR = "/path/to/output/vla-png"
THREADS = 20  # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: 10-30 –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç CPU/—Å–µ—Ç–∏

# –ò–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤–∞—à–µ–≥–æ MBTiles:
MIN_ZOOM = 4
MAX_ZOOM = 12
# bounds: west, south, east, north
BOUNDS = (35.045065, 54.270611, 48.982268, 57.90209)

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
CHECK_DISK_SPACE = False   # –≤–∫–ª—é—á–∏—Ç–µ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏
MIN_FREE_GB = 5

TIMEOUT = 10
MAX_RETRIES = 3
BACKOFF_FACTOR = 0.3
LOGFILE = 'generate_tiles.log'

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª –∏ –Ω–∞ stdout
logging.basicConfig(filename=LOGFILE, level=logging.INFO, format='%(asctime)s %(levelname)s: %(message)s')
logging.getLogger().addHandler(logging.StreamHandler(sys.stdout))

# HTTP session —Å retry
session = requests.Session()
retries = Retry(total=MAX_RETRIES, backoff_factor=BACKOFF_FACTOR,
                status_forcelist=(429, 500, 502, 503, 504), allowed_methods=("GET",))
session.mount('http://', HTTPAdapter(max_retries=retries))

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
def check_disk_space(path, min_free_gb=MIN_FREE_GB):
    try:
        total, used, free = shutil.disk_usage(path)
        free_gb = free / (1024 ** 3)
        logging.info(f"Free space at {path}: {free_gb:.2f} GB")
        return free_gb >= min_free_gb
    except Exception as e:
        logging.warning(f"Disk check failed: {e}")
        return False

# –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ tileserver
def wait_for_tileserver(timeout=30):
    start = time.time()
    while time.time() - start < timeout:
        try:
            r = session.get(f"{TILESERVER}/styles.json", timeout=5)
            if r.status_code == 200:
                logging.info('Tileserver –¥–æ—Å—Ç—É–ø–µ–Ω')
                return True
        except Exception:
            time.sleep(1)
    logging.error('Tileserver –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤ —Ç–µ—á–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–∞')
    return False

# –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º
if CHECK_DISK_SPACE and not check_disk_space(OUTPUT_DIR):
    logging.error(f"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –≤ {OUTPUT_DIR} (—Ç—Ä–µ–±—É–µ—Ç—Å—è >= {MIN_FREE_GB} GB)")
    sys.exit(2)

if not wait_for_tileserver(30):
    logging.error('Tileserver –Ω–µ –≥–æ—Ç–æ–≤ ‚Äî –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ')
    sys.exit(3) 

def lon2tile(lon, z):
    return int((lon + 180.0) / 360.0 * (1 << z))

def lat2tile(lat, z):
    lat_rad = math.radians(lat)
    return int((1.0 - math.asinh(math.tan(lat_rad)) / math.pi) / 2.0 * (1 << z))

def download_tile(z, x, y):
    url = f"{TILESERVER}/styles/{STYLE}/{z}/{x}/{y}.png"
    outdir = os.path.join(OUTPUT_DIR, str(z), str(x))
    outfile = os.path.join(outdir, f"{y}.png")

    if os.path.exists(outfile):
        return ("SKIP", z, x, y)

    try:
        os.makedirs(outdir, exist_ok=True)
        resp = session.get(url, timeout=TIMEOUT, stream=True)
        if resp.status_code == 404:
            return ("MISSING", z, x, y)
        resp.raise_for_status()
        with open(outfile, 'wb') as f:
            for chunk in resp.iter_content(4096):
                if chunk:
                    f.write(chunk)
        return ("OK", z, x, y)
    except Exception as e:
        return ("ERR", z, x, y, str(e))

def main():
    tasks = []
    west, south, east, north = BOUNDS

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á
    for z in range(MIN_ZOOM, MAX_ZOOM + 1):
        x_min = lon2tile(west, z)
        x_max = lon2tile(east, z)
        y_min = lat2tile(north, z)  # north ‚Üí –º–µ–Ω—å—à–∏–π y
        y_max = lat2tile(south, z)  # south ‚Üí –±–æ–ª—å—à–∏–π y

        print(f"Zoom {z}: –¥–∏–∞–ø–∞–∑–æ–Ω X[{x_min}-{x_max}], Y[{y_min}-{y_max}]")

        for x in range(x_min, x_max + 1):
            for y in range(y_min, y_max + 1):
                tasks.append((z, x, y))

    total_tasks = len(tasks)
    logging.info(f"–í—Å–µ–≥–æ —Ç–∞–π–ª–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: {total_tasks}")
    logging.info(f"–ó–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Å {THREADS} –ø–æ—Ç–æ–∫–∞–º–∏... (–ª–æ–≥: {LOGFILE})")

    stats = {"OK":0, "SKIP":0, "MISSING":0, "ERR":0} 
    with ThreadPoolExecutor(max_workers=THREADS) as executor:
        futures = {executor.submit(download_tile, z, x, y): (z, x, y) for (z, x, y) in tasks}
        for i, future in enumerate(tqdm(as_completed(futures), total=total_tasks, desc='tiles'), 1):
            result = future.result()
            status = result[0]
            stats[status] = stats.get(status, 0) + 1

            # –ü—Ä–æ–≥—Ä–µ—Å—Å –∏ –∫—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            if i % 100 == 0 or i == total_tasks:
                logging.info(f"–ü—Ä–æ–≥—Ä–µ—Å—Å: {i}/{total_tasks} ‚Äî OK:{stats['OK']} SKIP:{stats['SKIP']} MISS:{stats['MISSING']} ERR:{stats['ERR']}")

    logging.info(f"–ì–æ—Ç–æ–≤–æ! –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {stats}")

if __name__ == '__main__':
    main()
EOF

# 3. –£–ø–∞–∫–æ–≤–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ MBTiles (PNG —Ñ–æ—Ä–º–∞—Ç)
# –ù—É–∂–µ–Ω mb-util:
pip3 install mbutil

# –°–æ–∑–¥–∞—ë–º MBTiles –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ç–∞–π–ª–æ–≤
mb-util /path/to/output/vla-png /path/to/output/vla-raster.mbtiles --image_format=png --scheme=xyz

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: MBTiles –≤ —Ç–∞–±–ª–∏—Ü–µ `tiles` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç TMS‚Äë–Ω—É–º–µ—Ä–∞—Ü–∏—é `tile_row`. –£—Ç–∏–ª–∏—Ç–∞ `mb-util --scheme=xyz` —Å–æ–∑–¥–∞—ë—Ç MBTiles, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Å Leaflet/tileserver (XYZ). –ï—Å–ª–∏ –≤—ã –≤—Å—Ç–∞–≤–ª—è–µ—Ç–µ —Ç–∞–π–ª—ã –≤—Ä—É—á–Ω—É—é ‚Äî –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ Y:

```
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å metadata –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–π–ª–æ–≤ –ø–æ zoom
sqlite3 /path/to/output/vla-raster.mbtiles "SELECT name,value FROM metadata;"
sqlite3 /path/to/output/vla-raster.mbtiles "SELECT zoom_level, COUNT(*) FROM tiles GROUP BY zoom_level ORDER BY zoom_level;"
# –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç
sqlite3 /path/to/output/vla-raster.mbtiles "INSERT OR REPLACE INTO metadata (name, value) VALUES ('format','png');"
```
```

#### –í–∞—Ä–∏–∞–Ω—Ç C: –ß–µ—Ä–µ–∑ OpenMapTiles (–µ—Å–ª–∏ –µ—Å—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ OpenStreetMap (osm.pbf), –º–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ç—Ä–æ–≤—ã–µ —Ç–∞–π–ª—ã –Ω–∞–ø—Ä—è–º—É—é:

```bash
# –ò—Å–ø–æ–ª—å–∑—É–µ–º tippecanoe + magnacarto –∏–ª–∏ –∞–Ω–∞–ª–æ–≥
# –≠—Ç–æ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–π –ø—É—Ç—å, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –í–∞—Ä–∏–∞–Ω—Ç A –∏–ª–∏ B
```

### 3. –ó–∞–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤

–ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PNG MBTiles:

```bash
# –ó–∞–º–µ–Ω–∏—Ç–µ —Ñ–∞–π–ª—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ
cp vla-raster.mbtiles /path/to/project/offline-tiles/vla.mbtiles
cp vlacity-raster.mbtiles /path/to/project/offline-tiles/vlacity.mbtiles
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±—ç–∫–µ–Ω–¥
cd backend
SKIP_DB=true node server.js

# –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
# http://localhost:3002/test-tiles.html

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (—Ñ–æ—Ä–º–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å png)
curl http://localhost:3002/api/tiles/vla/metadata | jq .format
# –û–∂–∏–¥–∞–µ–º: "png"

# –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ MBTiles (–≤ –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞)
# (–ø—É—Ç—å –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è; –æ—Ç `backend` –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ../offline-tiles/...)
sqlite3 ../offline-tiles/vla.mbtiles "SELECT name,value FROM metadata;"
sqlite3 ../offline-tiles/vla.mbtiles "SELECT zoom_level, COUNT(*) FROM tiles GROUP BY zoom_level ORDER BY zoom_level;"

# –ï—Å–ª–∏ metadata.format –Ω–µ 'png', –∏—Å–ø—Ä–∞–≤—å—Ç–µ:
sqlite3 ../offline-tiles/vla.mbtiles "INSERT OR REPLACE INTO metadata (name, value) VALUES ('format','png');"
```

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–∞–π–ª—Å–µ—Ç–æ–≤

### vla (–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å)
- **Bounds**: 35.05, 54.27, 48.98, 57.90
- **Zoom**: 4-12
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –æ–±—â–∏–π –æ–±–∑–æ—Ä —Ä–µ–≥–∏–æ–Ω–∞

### vlacity (–≥–æ—Ä–æ–¥ –í–ª–∞–¥–∏–º–∏—Ä)
- **Bounds**: 35.05, 55.40, 42.12, 57.90
- **Zoom**: 8-16  
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –¥–µ—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å—Ç–æ–ª–∏—Ü—ã —Ä–µ–≥–∏–æ–Ω–∞

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞—Ä–µ–∑–∫–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤

–ü—Ä–∏ –Ω–∞—Ä–µ–∑–∫–µ —Ç–∞–π–ª–æ–≤ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:

```bash
# –§–æ—Ä–º–∞—Ç: PNG (–Ω–µ PBF!)
# –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ zoom-—É—Ä–æ–≤–Ω–∏:
#   –û–±–ª–∞—Å—Ç—å: 4-12 (–æ–±–∑–æ—Ä)
#   –ì–æ—Ä–æ–¥:   8-16 (–¥–µ—Ç–∞–ª—å–Ω—ã–π)
#
# –†–∞–∑–º–µ—Ä –æ—Ü–µ–Ω–∫–∞:
#   Zoom 4-12, –æ–¥–∏–Ω —Ä–µ–≥–∏–æ–Ω: ~100-200 –ú–ë (PNG)
#   Zoom 8-16, –æ–¥–∏–Ω –≥–æ—Ä–æ–¥:  ~50-150 –ú–ë (PNG)
```

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Å–æ–≤–µ—Ç—ã
- 404 –Ω–∞ —Ç–∞–π–ª—ã ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ—á–Ω–æ–µ –∏–º—è `STYLE` (curl /styles.json) –∏ `minzoom/maxzoom` –≤ metadata. ‚ö†Ô∏è
- –ü–æ—Ä—Ç 8080 –∑–∞–Ω—è—Ç ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç –≤ `-p` –∏–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å.
- –ü—Ä–æ–±–ª–µ–º—ã —Å –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ Docker –Ω–∞ Windows ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `d:/path` –∏–ª–∏ WSL –ø—É—Ç—å `/mnt/d/...`, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–ø–∫–µ.
- –ë–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ ‚Üí —É–º–µ–Ω—å—à–∏—Ç–µ `THREADS`, –µ—Å–ª–∏ –≤–∏–¥–∏—Ç–µ —Ç–∞–π–º–∞—É—Ç—ã/–æ—à–∏–±–∫–∏ —Å–µ—Ç–∏.
- –§–æ—Ä–º–∞—Ç –≤ metadata –Ω–µ `png` ‚Üí –∏—Å–ø—Ä–∞–≤—å—Ç–µ —á–µ—Ä–µ–∑ sqlite3 (—Å–º. –≤—ã—à–µ).

## –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (–±–µ–∑ –ø–µ—Ä–µ–Ω–∞—Ä–µ–∑–∫–∏) 

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –±—ã—Å—Ç—Ä–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ tile server —Ä–∞–±–æ—Ç–∞–µ—Ç, –º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –≥–æ—Ç–æ–≤—ã–µ PNG —Ç–∞–π–ª—ã:

```bash
# –°–∫–∞—á–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Ä–∞—Å—Ç—Ä–æ–≤—ã–µ —Ç–∞–π–ª—ã –†–æ—Å—Å–∏–∏ (OpenStreetMap)
wget -O /path/to/offline-tiles/test-osm.mbtiles \
  "https://download.maptiler.com/osm/planet_z0-z5_2023.mbtiles"
```

–ò–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–π —Ç–µ—Å—Ç–æ–≤—ã–π MBTiles —á–µ—Ä–µ–∑ Python:

```bash
pip install Pillow
python3 -c "
import sqlite3, io
from PIL import Image, ImageDraw, ImageFont

db = sqlite3.connect('test-raster.mbtiles')
db.execute('CREATE TABLE IF NOT EXISTS metadata (name TEXT, value TEXT)')
db.execute('CREATE TABLE IF NOT EXISTS tiles (zoom_level INTEGER, tile_column INTEGER, tile_row INTEGER, tile_data BLOB)')
db.execute(\"INSERT INTO metadata VALUES ('format', 'png')\")
db.execute(\"INSERT INTO metadata VALUES ('bounds', '39.5,55.5,41.5,56.8')\")
db.execute(\"INSERT INTO metadata VALUES ('center', '40.4,56.1,10')\")
db.execute(\"INSERT INTO metadata VALUES ('minzoom', '8')\")
db.execute(\"INSERT INTO metadata VALUES ('maxzoom', '12')\")
db.execute(\"INSERT INTO metadata VALUES ('name', 'test-raster')\")
db.execute(\"INSERT INTO metadata VALUES ('description', 'Test raster tileset')\")

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ç–∞–π–ª–æ–≤ (—Ü–≤–µ—Ç–Ω—ã–µ –∫–≤–∞–¥—Ä–∞—Ç—ã —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏)
import math
for z in range(8, 13):
    x_min = int((39.5 + 180) / 360 * (1 << z))
    x_max = int((41.5 + 180) / 360 * (1 << z))
    y_min_slippy = int((1 - math.asinh(math.tan(math.radians(56.8))) / math.pi) / 2 * (1 << z))
    y_max_slippy = int((1 - math.asinh(math.tan(math.radians(55.5))) / math.pi) / 2 * (1 << z))
    for x in range(x_min, x_max + 1):
        for y in range(y_min_slippy, y_max_slippy + 1):
            img = Image.new('RGBA', (256, 256), (59, 130, 246, 40))
            draw = ImageDraw.Draw(img)
            draw.rectangle([0, 0, 255, 255], outline=(59, 130, 246, 120), width=1)
            draw.text((10, 10), f'{z}/{x}/{y}', fill=(255, 255, 255, 200))
            buf = io.BytesIO()
            img.save(buf, 'PNG')
            tms_y = (1 << z) - 1 - y  # convert Slippy Y -> TMS Y for MBTiles
            db.execute('INSERT INTO tiles VALUES (?, ?, ?, ?)', (z, x, tms_y, buf.getvalue()))

db.commit()
db.close()
print('–°–æ–∑–¥–∞–Ω test-raster.mbtiles')
"
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤ offline-tiles/
# Linux/macOS:
mv test-raster.mbtiles /–ø—É—Ç—å/–∫/–ø—Ä–æ–µ–∫—Ç—É/offline-tiles/

# Windows (PowerShell):
Move-Item test-raster.mbtiles d:\path\to\project\offline-tiles\

# –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –Ω–∞ Windows –∞–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ –ø—É—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–º–µ–Ω–∏—Ç–µ `d:\path\to\project` –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å).
```