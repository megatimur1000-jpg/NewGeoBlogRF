# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞—Å–∞–¥–∞ –∏ –ø—Ä–æ–±–ª–µ–º —Å –ø–æ–ø–∞–ø–∞–º–∏

## üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå –î–í–û–ô–ù–ê–Ø –ì–†–£–ü–ü–ê –ö–õ–ê–°–¢–ï–†–û–í

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `leafletAdapter.ts` —Å–æ–∑–¥–∞–µ—Ç –≥—Ä—É–ø–ø—É –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∞ 44)
- `Map.tsx` —Å–æ–∑–¥–∞–µ—Ç –°–í–û–Æ –≥—Ä—É–ø–ø—É –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ (—Å—Ç—Ä–æ–∫–∞ 793)
- –î–≤–µ –≥—Ä—É–ø–ø—ã –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞—Ä—Ç—ã –∏–∑ —Ñ–∞—Å–∞–¥–∞ —É–¥–∞–ª—è–µ–º –≥—Ä—É–ø–ø—É –∫–ª–∞—Å—Ç–µ—Ä–æ–≤, —Å–æ–∑–¥–∞–Ω–Ω—É—é —Ñ–∞—Å–∞–¥–æ–º
- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –≥—Ä—É–ø–ø—É –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –∏–∑ Map.tsx

### 2. ‚ùå –ü–û–ü–ê–ü–´ –°–û–ó–î–ê–Æ–¢–°–Ø –î–û –ì–û–¢–û–í–ù–û–°–¢–ò –ö–ê–†–¢–´

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–æ–±—ã—Ç–∏–µ `popupopen` –º–æ–∂–µ—Ç —Å—Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã
- tileLayer –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω
- DOM —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ–ø–∞–ø–∞ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ –≥–æ—Ç–æ–≤—ã

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è `mapRef.current`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è `tileLayer` (–ø—Ä–∏–∑–Ω–∞–∫ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–∞—Ä—Ç—ã)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–ø–∞–ø–∞ –≤ DOM –¥–µ—Ä–µ–≤–µ
- –û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ø–∞–ø–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### 3. ‚ùå –ì–†–£–ü–ü–ê –ö–õ–ê–°–¢–ï–†–û–í –î–û–ë–ê–í–õ–Ø–ï–¢–°–Ø –î–û –ì–û–¢–û–í–ù–û–°–¢–ò –ö–ê–†–¢–´

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ì—Ä—É–ø–ø–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ tileLayer –¥–æ–±–∞–≤–ª–µ–Ω
- –≠—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –º–∞—Ä–∫–µ—Ä–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è tileLayer –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≥—Ä—É–ø–ø—ã –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
- –û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–µ–π –≥—Ä—É–ø–ø—ã –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ (Map.tsx:536-549)

```typescript
// –ö–†–ò–¢–ò–ß–ù–û: –£–¥–∞–ª—è–µ–º –≥—Ä—É–ø–ø—É –∫–ª–∞—Å—Ç–µ—Ä–æ–≤, —Å–æ–∑–¥–∞–Ω–Ω—É—é —Ñ–∞—Å–∞–¥–æ–º, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
map.eachLayer((layer: any) => {
  if (layer && typeof layer.getLayers === 'function' && layer !== markerClusterGroupRef.current) {
    try {
      map.removeLayer(layer);
    } catch (e) {}
  }
});
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–∞—Ä—Ç—ã –¥–ª—è –ø–æ–ø–∞–ø–æ–≤ (Map.tsx:896-924)

```typescript
// –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞—Ä—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
if (!mapRef.current) {
  setTimeout(() => {
    if (leafletMarker.getPopup() && leafletMarker.isPopupOpen()) {
      leafletMarker.openPopup();
    }
  }, 100);
  return;
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞—Ä—Ç–∞ –∏–º–µ–µ—Ç tileLayer (–ø—Ä–∏–∑–Ω–∞–∫ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏)
let hasTileLayer = false;
mapRef.current.eachLayer((layer: any) => {
  if (layer instanceof L.TileLayer) {
    hasTileLayer = true;
  }
});

if (!hasTileLayer) {
  setTimeout(() => {
    if (leafletMarker.getPopup() && leafletMarker.isPopupOpen()) {
      leafletMarker.openPopup();
    }
  }, 200);
  return;
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–æ–ø–∞–ø –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤ DOM
if (!document.body.contains(popupElement)) {
  console.warn('‚ö†Ô∏è –ü–æ–ø–∞–ø –Ω–µ –≤ DOM –¥–µ—Ä–µ–≤–µ');
  return;
}
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–∞—Ä—Ç—ã –¥–ª—è –≥—Ä—É–ø–ø—ã –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ (Map.tsx:1172-1193)

```typescript
// –ö–†–ò–¢–ò–ß–ù–û: –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–∞—Ä—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≥—Ä—É–ø–ø—ã –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
let hasTileLayer = false;
mapRef.current.eachLayer((layer: any) => {
  if (layer instanceof L.TileLayer) {
    hasTileLayer = true;
  }
});

if (!hasTileLayer) {
  console.warn('‚ö†Ô∏è –ö–∞—Ä—Ç–∞ –Ω–µ –∏–º–µ–µ—Ç tileLayer, –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã –∫–ª–∞—Å—Ç–µ—Ä–æ–≤');
  setTimeout(() => {
    if (mapRef.current && !markerClusterGroupRef.current) {
      markerClusterGroup.addTo(mapRef.current);
      markerClusterGroupRef.current = markerClusterGroup;
    }
  }, 100);
} else {
  markerClusterGroup.addTo(mapRef.current);
  markerClusterGroupRef.current = markerClusterGroup;
}
```

---

## üìä –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

| –ü—Ä–æ–±–ª–µ–º–∞ | –°—Ç–∞—Ç—É—Å |
|----------|--------|
| –î–≤–æ–π–Ω–∞—è –≥—Ä—É–ø–ø–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| –ü–æ–ø–∞–ø—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–∞—Ä—Ç—ã | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| –ì—Ä—É–ø–ø–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ tileLayer | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (–≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö) |

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

1. ‚úÖ –ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å tileLayer
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –≥—Ä—É–ø–ø–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
3. ‚úÖ –ü–æ–ø–∞–ø—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–∞—Ä—Ç—ã
4. ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É —Ñ–∞—Å–∞–¥–æ–º –∏ –ø—Ä—è–º—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Leaflet
5. ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–∞—Ä—Ç—ã –Ω–∞ –º–µ—Å—Ç–µ

---

## üîç –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã

### –ü–æ—Ä—è–¥–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Ñ–∞—Å–∞–¥** (Map.tsx:458)
   - `mapFacade.initializeMap()` ‚Üí `leafletAdapter.initializeLeaflet()`
   - –°–æ–∑–¥–∞–µ—Ç—Å—è –∫–∞—Ä—Ç–∞ —á–µ—Ä–µ–∑ `L.map()`
   - –°–æ–∑–¥–∞–µ—Ç—Å—è –≥—Ä—É–ø–ø–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ (—Ñ–∞—Å–∞–¥)

2. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã** (Map.tsx:461)
   - `mapFacade.getMap()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞—Ä—Ç—É

3. **–£–¥–∞–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ —Ñ–∞—Å–∞–¥–∞** (Map.tsx:536-549)
   - –£–¥–∞–ª—è–µ–º –≥—Ä—É–ø–ø—É, —Å–æ–∑–¥–∞–Ω–Ω—É—é —Ñ–∞—Å–∞–¥–æ–º

4. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ tileLayer** (Map.tsx:508-515)
   - –í–°–ï–ì–î–ê –¥–æ–±–∞–≤–ª—è–µ–º tileLayer (–∫—Ä–∏—Ç–∏—á–Ω–æ!)

5. **–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤** (Map.tsx:808+)
   - –°–æ–∑–¥–∞–µ–º —Å–≤–æ—é –≥—Ä—É–ø–ø—É –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
   - –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫–∞—Ä—Ç—ã (–Ω–∞–ª–∏—á–∏–µ tileLayer)
   - –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –≤ –≥—Ä—É–ø–ø—É –∫–ª–∞—Å—Ç–µ—Ä–æ–≤

6. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ø–∞–ø–æ–≤** (Map.tsx:894+)
   - –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫–∞—Ä—Ç—ã
   - –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ tileLayer
   - –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ø–∞–ø–∞ –≤ DOM
   - –°–æ–∑–¥–∞–µ–º React root –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º MarkerPopup

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **tileLayer - –∫—Ä–∏—Ç–∏—á–µ–Ω!** –ë–µ–∑ –Ω–µ–≥–æ –∫–∞—Ä—Ç–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
2. **–ì—Ä—É–ø–ø–∞ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ - —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞!** –£–¥–∞–ª—è–µ–º –≥—Ä—É–ø–ø—É —Ñ–∞—Å–∞–¥–∞
3. **–ü–æ–ø–∞–ø—ã - —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏!** –ü—Ä–æ–≤–µ—Ä—è–µ–º tileLayer –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º
4. **DOM –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞!** –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ DOM

