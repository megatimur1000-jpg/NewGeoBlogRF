План реализации: Отказ от аналитики («Do Not Track»)
Этап 1: Бэкенд — подготовка данных
Добавить колонку analytics_opt_out (тип: BOOLEAN, значение по умолчанию: false) в таблицу users.
Обновить схему DTO профиля пользователя — включить поле analyticsOptOut.
Реализовать API-эндпоинт PATCH /api/user/profile с поддержкой обновления поля analyticsOptOut.
Настроить middleware или сервис-прослойку, которая проверяет флаг analytics_opt_out перед сохранением поведенческих событий в аналитическую БД.
Этап 2: Фронтенд — управление состоянием
Обновить тип User во фронтенд-модели — добавить поле analyticsOptOut.
Создать хук useAnalyticsConsent():
Возвращает текущее значение согласия (isTrackingEnabled).
Предоставляет функцию setAnalyticsOptOut(value: boolean).
Обновить AnalyticsProvider:
Читать analyticsOptOut из профиля пользователя.
Не инициализировать аналитические сервисы, если analyticsOptOut === true.
Этап 3: Фронтенд — защита вызовов трекинга
Во всех аналитических сервисах (productAnalyticsService, behavioralAnalyticsService и др.) добавить проверку: если трекинг отключён — прерывать выполнение.
Обновить useComprehensiveAnalytics():
Все методы (track, trackMapInteraction, trackTravelPattern и т.д.) должны молча игнорировать вызов при отключённом трекинге.
Убедиться, что автоматический трекинг страниц, ошибок и производительности также учитывает флаг.
Этап 4: UI — настройка в профиле
В разделе «Настройки профиля» добавить новый блок: «Конфиденциальность и аналитика».
Разместить переключатель с подписью:
«Помогать улучшать ГеоБлог»
Мы собираем анонимные данные об использовании: как вы работаете с картой, создаете посты, используете офлайн-режим. Это помогает нам делать сервис удобнее.
По клику на переключатель — вызывать setAnalyticsOptOut() и сохранять настройку через API.
Сразу отражать изменение состояния (без перезагрузки).
Этап 5: Документация и прозрачность
Обновить страницу «Политика конфиденциальности»:
Добавить раздел: «Аналитика и отказ от сбора данных».
Указать, какие данные собираются, зачем, и как отключить.
Чётко написать: «Отказ не влияет на функциональность сервиса».
Добавить короткую подсказку рядом с переключателем:
«Можно изменить в любой момент».
Этап 6: Тестирование
Авторизоваться под тестовым пользователем.
Включить отказ от трекинга.
Проверить:
Нет вызовов к /api/analytics/track.
Нет вызовов к внешним системам (GA4, Yandex.Metrika и др.).
Ошибки и производительность всё ещё логируются (если решено оставить).
Интерфейс работает без изменений.
Повторить с выключенным отказом — убедиться, что трекинг работает.
Этап 7: Логика по умолчанию
Для новых пользователей: analyticsOptOut = false (трекинг включён по умолчанию).
Для гостей (неавторизованных):
Включать только анонимную, неперсонализированную аналитику (например, PageView без userID).
Не собирать геоданные, поведенческие паттерны, треки.
При первом входе — не показывать баннер согласия (не GDPR), но дать доступ к настройке.