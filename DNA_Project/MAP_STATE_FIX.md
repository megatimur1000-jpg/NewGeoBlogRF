# üó∫Ô∏è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç—ã –∏ –º–∞—Ä–∫–µ—Ä–æ–≤

## –î–∞—Ç–∞: 2025-01-XX

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ Map.tsx –∏ Planner.tsx –Ω–∞–±–ª—é–¥–∞–ª–∏—Å—å –¥–≤–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–†–∞–∑–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç—ã**: –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è Map ‚Üí Planner ‚Üí Map –∑—É–º –∏ —Ü–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã —Å–±—Ä–∞—Å—ã–≤–∞–ª–∏—Å—å
2. **–ü–æ—Ç–µ—Ä—è –º–∞—Ä–∫–µ—Ä–æ–≤**: –ú–∞—Ä–∫–µ—Ä—ã –∏—Å—á–µ–∑–∞–ª–∏ –ø–æ—Å–ª–µ 3-—Ö –ø–æ–ø—ã—Ç–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–∑-–∑–∞ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–Ω–¥–µ—Ä–µ—Ä–∞

## –ö–æ—Ä–Ω–µ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã

### –ü—Ä–∏—á–∏–Ω–∞ 1: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç—ã

- Map.tsx –∏ Planner.tsx –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ **—Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã** (`#map` –∏ `#planner-map-container`)
- –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ `projectManager.initializeMap` **–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–ª** –≥–ª–æ–±–∞–ª—å–Ω—ã–π `mapApi`
- –¶–µ–Ω—Ç—Ä/–∑—É–º –∫–∞—Ä—Ç—ã —Ö—Ä–∞–Ω–∏–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º `mapRef.current` –∏ —Ç–µ—Ä—è–ª–∏—Å—å –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏

### –ü—Ä–∏—á–∏–Ω–∞ 2: –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–Ω–¥–µ—Ä–µ—Ä–∞

- –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (osm ‚Üî planner) –≤—ã–∑—ã–≤–∞–ª—Å—è `switchToRenderer`
- `switchToRenderer` —É–Ω–∏—á—Ç–æ–∂–∞–ª —Ç–µ–∫—É—â–∏–π —Ä–µ–Ω–¥–µ—Ä–µ—Ä —á–µ—Ä–µ–∑ `currentRenderer?.destroy()`
- –ú–∞—Ä–∫–µ—Ä—ã —Ö—Ä–∞–Ω–∏–ª–∏—Å—å –≤ `INTERNAL.externalMarkers`, –Ω–æ –ø—Ä–∏–≤—è–∑—ã–≤–∞–ª–∏—Å—å –∫ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–Ω–æ–º—É —Ä–µ–Ω–¥–µ—Ä–µ—Ä—É

### –ü—Ä–∏—á–∏–Ω–∞ 3: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ PageLayer

- PageLayer –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `display: none/block` –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è/–ø–æ–∫–∞–∑–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
- Map –∏ Planner –º–æ–Ω—Ç–∏—Ä—É—é—Ç—Å—è **–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**, –Ω–æ –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞
- –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–∞—Ä—Ç–∞ –º–æ–≥–ª–∞ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è

## –†–µ—à–µ–Ω–∏–µ

### –§–∞–π–ª 1: `frontend/src/stores/mapStateStore.ts` (–ù–û–í–´–ô)

–°–æ–∑–¥–∞–Ω–æ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ Zustand —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç—ã:

```typescript
interface MapStateStore {
  contexts: {
    osm: MapContextState;      // Map.tsx
    planner: MapContextState;  // Planner.tsx
    offline: MapContextState;  // Offline —Ä–µ–∂–∏–º
  };
  globalMarkers: any[];        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –º–∞—Ä–∫–µ—Ä–æ–≤
  markersLoaded: boolean;
  // –ú–µ—Ç–æ–¥—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
  saveCurrentState(context, center, zoom): void;
  restoreState(context): MapContextState | null;
  setGlobalMarkers(markers): void;
}
```

### –§–∞–π–ª 2: `frontend/src/components/Map/Map.tsx`

1. –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `useMapStateStore`
2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã —Ç–µ–ø–µ—Ä—å –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
   ```typescript
   const savedState = mapStateHelpers.getCenterAndZoom('osm');
   const config = {
     center: savedState.center,
     zoom: savedState.zoom,
     preserveState: true,
   };
   ```
3. –î–æ–±–∞–≤–ª–µ–Ω useEffect –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:
   ```typescript
   useEffect(() => {
     if (!mapRef.current || !isMapReady) return;
     const saveState = () => {
       const currentCenter = map.getCenter();
       const currentZoom = map.getZoom();
       useMapStateStore.getState().saveCurrentState('osm', [lat, lng], zoom);
     };
     map.on('moveend', saveState);
     map.on('zoomend', saveState);
   }, [isMapReady]);
   ```

### –§–∞–π–ª 3: `frontend/src/pages/Map.tsx`

1. –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
2. –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π store:
   ```typescript
   mapStateHelpers.setMarkers(markers);
   ```
3. –î–æ–±–∞–≤–ª–µ–Ω —ç—Ñ—Ñ–µ–∫—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤ –∏–∑ –∫—ç—à–∞:
   ```typescript
   useEffect(() => {
     if (markersLoaded && cachedMarkers.length > 0 && allMarkers.length === 0) {
       setAllMarkers(restoredMarkers);
       INTERNAL.externalMarkers = cachedMarkers;
     }
   }, [markersLoaded, cachedMarkers.length]);
   ```

### –§–∞–π–ª 4: `frontend/src/pages/Planner.tsx`

1. –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç 'planner':
   ```typescript
   const savedState = mapStateHelpers.getCenterAndZoom('planner');
   const config = {
     center: savedState.center,
     zoom: savedState.zoom,
     context: 'planner',
     preserveState: true,
   };
   ```

### –§–∞–π–ª 5: `frontend/src/services/map_facade/MapContextFacade.ts`

1. –û–±–Ω–æ–≤–ª—ë–Ω –º–µ—Ç–æ–¥ `switchToRenderer` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤:
   ```typescript
   private switchToRenderer(context: MapContext): void {
     // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –ü–ï–†–ï–î —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ–º
     const savedMarkers = this.pendingExternalMarkers.length > 0 
       ? this.pendingExternalMarkers 
       : ((this as any).INTERNAL?.externalMarkers || []);
     
     this.currentRenderer?.destroy();
     // ... –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–µ—Ä–∞ ...
     
     // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –ü–û–°–õ–ï –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
     if (savedMarkers.length > 0) {
       this.pendingExternalMarkers = savedMarkers;
     }
   }
   ```

## –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –î–µ–π—Å—Ç–≤–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|----------|
| `stores/mapStateStore.ts` | –°–û–ó–î–ê–ù | –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è |
| `components/Map/Map.tsx` | –ò–ó–ú–ï–ù–Å–ù | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ state |
| `pages/Map.tsx` | –ò–ó–ú–ï–ù–Å–ù | –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ |
| `pages/Planner.tsx` | –ò–ó–ú–ï–ù–Å–ù | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ 'planner' |
| `services/map_facade/MapContextFacade.ts` | –ò–ó–ú–ï–ù–Å–ù | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–Ω–¥–µ—Ä–µ—Ä–∞ |

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É Map –∏ Planner
1. –û—Ç–∫—Ä—ã—Ç—å Map, –ø–µ—Ä–µ–π—Ç–∏ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–æ—á–∫–µ, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑—É–º
2. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ Planner
3. –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ Map
4. **–û–∂–∏–¥–∞–Ω–∏–µ**: –ö–∞—Ä—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–∑–∏—Ü–∏—é –∏ –∑—É–º

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ú–∞—Ä–∫–µ—Ä—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
1. –û—Ç–∫—Ä—ã—Ç—å Map, —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –º–∞—Ä–∫–µ—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
2. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ Planner, –ø–æ—Ç–æ–º –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ Map
3. **–û–∂–∏–¥–∞–Ω–∏–µ**: –ú–∞—Ä–∫–µ—Ä—ã –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
1. –û—Ç–∫—Ä—ã—Ç—å Map, –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
2. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
3. **–û–∂–∏–¥–∞–Ω–∏–µ**: –ú–∞—Ä–∫–µ—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω–æ

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Zustand –¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –ö–∞–∂–¥—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (osm, planner, offline) –∏–º–µ–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –ú–∞—Ä–∫–µ—Ä—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
- –ü—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–Ω–¥–µ—Ä–µ—Ä–∞ –º–∞—Ä–∫–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞—é—Ç—Å—è
