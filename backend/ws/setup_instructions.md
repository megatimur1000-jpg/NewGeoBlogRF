# Инструкция по настройке WebSocket-сервера для чата

## Шаг 1: Подготовка базы данных

1. Откройте phpMyAdmin из панели управления XAMPP
2. Выберите вашу базу данных
3. Перейдите на вкладку "Импорт"
4. Выберите файл `chat_tables.sql` и нажмите "Выполнить"

Этот скрипт создаст необходимые таблицы:
- `chat_rooms` - для комнат чата (хэштегов)
- `chat_messages` - для сообщений чата

## Шаг 2: Установка библиотеки Ratchet

1. Откройте PowerShell или командную строку
2. Перейдите в директорию WebSocket-сервера:
```
cd D:\xampp\htdocs\my_site\ws
```
3. Установите зависимости с помощью Composer:
```
D:\xampp\php\php.exe D:\path\to\composer\composer.phar install
```

Если у вас установлен Composer глобально:
```
composer install
```

## Шаг 3: Настройка портов

1. По умолчанию WebSocket-сервер использует порт 8080
2. Убедитесь, что этот порт не занят другими приложениями
3. Откройте этот порт в вашем брандмауэре:
   - Откройте Панель управления > Система и безопасность > Брандмауэр Защитника Windows
   - Выберите "Дополнительные параметры"
   - Выберите "Правила для входящих подключений" > "Создать правило"
   - Выберите "Для порта", нажмите "Далее"
   - Выберите "TCP" и укажите порт "8080", нажмите "Далее"
   - Выберите "Разрешить подключение", нажмите "Далее"
   - Выберите все профили, нажмите "Далее"
   - Укажите имя правила (например, "WebSocket Chat") и нажмите "Готово"

## Шаг 4: Запуск сервера

### Временный запуск для тестирования

Запустите файл `start_chat_server.bat` двойным щелчком или через командную строку:
```
D:\xampp\htdocs\my_site\ws\start_chat_server.bat
```

### Настройка автозапуска (опционально)

Для автоматического запуска сервера вместе с Windows:

1. Скачайте утилиту NSSM (Non-Sucking Service Manager): https://nssm.cc/
2. Распакуйте архив и откройте командную строку от имени администратора
3. Перейдите в директорию с распакованными файлами
4. Выполните команды:
```
nssm install WanderisChat "D:\xampp\htdocs\my_site\ws\start_chat_server.bat"
nssm set WanderisChat AppDirectory "D:\xampp\htdocs\my_site\ws"
nssm set WanderisChat Description "Wanderis Chat WebSocket Server"
nssm start WanderisChat
```

## Шаг 5: Проверка работы сервера

1. Откройте в браузере страницу со статусом сервера:
```
http://localhost/my_site/ws/check_server.php
```

2. Вы должны увидеть статус "Работает" если сервер успешно запущен

## Шаг 6: Тестирование чата

1. Откройте в браузере страницу сообщества:
```
http://localhost/my_site/community.php
```

2. Откройте консоль разработчика в браузере (F12)
3. Проверьте, что WebSocket-соединение установлено (в вкладке Network/Сеть)
4. Попробуйте отправить сообщение в чат

## Разрешение проблем

1. **Проблема**: Сервер не запускается
   **Решение**: Проверьте, что порт 8080 не занят другим приложением:
   ```
   netstat -ano | findstr :8080
   ```
   
2. **Проблема**: Ошибка "Failed to listen on localhost:8080"
   **Решение**: Попробуйте изменить порт в файле `server.php`

3. **Проблема**: Не удается подключиться к WebSocket
   **Решение**: Проверьте, что URL в `chat.js` соответствует хосту и порту вашего сервера

4. **Проблема**: Ошибка "Class 'Ratchet\Server\IoServer' not found"
   **Решение**: Убедитесь, что вы установили зависимости через Composer

## Примечания для продакшена

1. Для продакшен-среды рекомендуется настроить SSL для WebSocket (WSS)
2. Ограничьте доступ к WebSocket-серверу только для вашего домена
3. Настройте прокси через Nginx или Apache для перенаправления WebSocket запросов
4. Используйте системный сервис (systemd на Linux) для поддержания сервера в рабочем состоянии 