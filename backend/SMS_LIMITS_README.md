# SMS-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Å –ª–∏–º–∏—Ç–∞–º–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º

## üöÄ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### ‚úÖ 1. –°–∏—Å—Ç–µ–º–∞ –ª–∏–º–∏—Ç–æ–≤ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É SMS

**–õ–∏–º–∏—Ç—ã:**
- **3 SMS –∑–∞ 5 –º–∏–Ω—É—Ç** - –∑–∞—â–∏—Ç–∞ –æ—Ç —Ñ–ª—É–¥–∞
- **10 SMS –∑–∞ —á–∞—Å** - –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞
- **50 SMS –∑–∞ —Å—É—Ç–∫–∏** - –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π

### ‚úÖ 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫

**–¢–∞–±–ª–∏—Ü–∞ `sms_logs`:**
- –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- –¢–∏–ø SMS (verification, password_reset)
- –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏
- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
- –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏

### ‚úÖ 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**API endpoints –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:**
- `GET /api/sms/stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –Ω–æ–º–µ—Ä—É –∏–ª–∏ –æ–±—â–∞—è
- `GET /api/sms/failed-attempts` - –ª–æ–≥–∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∫–ª—é—á–∞–µ—Ç:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
- –¢–æ–ø-10 –Ω–æ–º–µ—Ä–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ–ø—ã—Ç–æ–∫
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞

## üìã –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –≤ –∫–æ–¥–µ

```javascript
// –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π SMS
const limitsCheck = await checkSMSSendLimits(phone);

if (!limitsCheck.allowed) {
  await logSMSTry(phone, 'verification', false, limitsCheck.message);
  return res.status(429).json({
    message: limitsCheck.message,
    retryAfter: limitsCheck.limit
  });
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ SMS –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
try {
  await smsService.sendVerificationCode(phone, code);
  await logSMSTry(phone, 'verification', true);
} catch (error) {
  await logSMSTry(phone, 'verification', false, error.message);
  throw error;
}
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

```javascript
// –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
const stats = await getSMSStats(phone, 'hour');

// –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
  total: 5,
  successful: 4,
  failed: 1
}
```

## üéØ –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π

### –ê—Ç–∞–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è:
1. **–§–ª—É–¥ SMS** - –±–æ–ª—å—à–µ 3 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ 5 –º–∏–Ω—É—Ç
2. **–°–ø–∞–º SMS** - –±–æ–ª—å—à–µ 10 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ —á–∞—Å
3. **–ó–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è** - –±–æ–ª—å—à–µ 50 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ —Å—É—Ç–∫–∏

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
- –ê–Ω–∞–ª–∏–∑ —Ñ—Ä–æ–¥-–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –Ω–æ–º–µ—Ä–∞–º

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **HTTP 429** (Too Many Requests) –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤
- **Retry-After** –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –≤—Ä–µ–º–µ–Ω–µ–º –æ–∂–∏–¥–∞–Ω–∏—è
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- **–ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞** –∏ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
```bash
curl -H "Authorization: Bearer TOKEN" \
  http://localhost:3002/api/sms/stats?phone=+79991234567
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫:
```bash
curl -H "Authorization: Bearer TOKEN" \
  http://localhost:3002/api/sms/failed-attempts
```

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

- [x] –°–∏—Å—Ç–µ–º–∞ –ª–∏–º–∏—Ç–æ–≤ (3 –∑–∞ 5 –º–∏–Ω, 10 –∑–∞ —á–∞—Å, 50 –∑–∞ —Å—É—Ç–∫–∏)
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS
- [x] –ó–∞—â–∏—Ç–∞ –æ—Ç —Ñ–ª—É–¥–∞ –∏ —Å–ø–∞–º–∞
- [x] HTTP 429 –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤
- [x] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- [x] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–±–ª–µ–º




